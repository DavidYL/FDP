---
title: "Biomarkers_baseline"
author: "David Mui√±a"
date: "2024-02-07"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

set.seed(123)

```


```{r packages}

library(readxl)
library(kableExtra)
library(compareGroups)
library(dplyr)
library(lubridate)
library(tidyr)
library(rmarkdown)
library(boot)
library(ggplot2)
library(lm.beta)
library(excel.link)
library(openxlsx)
library(car)
library(multcomp)
library(lme4)
library(lmerTest)
library(MASS)
library(scales)
library(plotly)
library(bootstrap)
```



```{r read_dataset}

df <- xl.read.file("longitudinal_dataset_20240111_password_2.xlsx", password = "bbrc_2024")

set.seed(123)

# Remove current row names
row.names(df) <- NULL

# Reset row names to start from 1
row.names(df) <- 1:nrow(df)
```


```{r}
# Read Excel file into dataframe "janssen"
janssen <- xl.read.file("ALFA+_Janssen plasma p217+tau_password_Dec2023_2.xlsx", password = "ALFA-JJIM")

# Select specific columns in "janssen" dataframe
janssen <- janssen %>% dplyr::select("Sample ID", "Dilution Corrected Conc. (pg/mL)", "JJIM_notes")

# Remove current row names
row.names(janssen) <- NULL

# Remove rows from 1 to 33 in the "janssen" dataframe
janssen <- janssen %>% slice(34:n())

# Read Excel file into dataframe "shipment"
shipment <- xl.read.file("Janssen_V0.1.2_Shipment.xlsx")

# Filter "shipment" dataframe to include only rows where ID ends with V1 or V2
shipment <- shipment %>%
  filter(grepl("V[12]$", ID))

# Match indices of "Sample ID" in "janssen" with "TUBE ID LVL" in "shipment"
matching_indices <- match(janssen$`Sample ID`, shipment$`TUBE ID LVL `)

# Filter "janssen" dataframe based on matching indices
janssen <- janssen[!is.na(matching_indices), ]

# Remove rows from 1 to 19 in the "shipment" dataframe
shipment <- shipment %>% slice(20:n())

# Add the "ID" column from "shipment" to "janssen"
janssen$ID <- shipment$ID

# Extract ParticipantID from ID column
janssen <- janssen %>%
  mutate(ParticipantID = sub("_.*", "", ID))

# Read Excel file into dataframe "janssen"
janssen <- xl.read.file("ALFA+_Janssen plasma p217+tau_password_Dec2023_2.xlsx", password = "ALFA-JJIM")

# Select specific columns in "janssen" dataframe
janssen <- janssen %>% dplyr::select("Sample ID", "Dilution Corrected Conc. (pg/mL)", "JJIM_notes")

# Remove current row names
row.names(janssen) <- NULL

# Remove rows from 1 to 33 in the "janssen" dataframe
janssen <- janssen %>% slice(34:n())

# Read Excel file into dataframe "shipment"
shipment <- xl.read.file("Janssen_V0.1.2_Shipment.xlsx")

# Filter "shipment" dataframe to include only rows where ID ends with V1 or V2
shipment <- shipment %>%
  filter(grepl("V[12]$", ID))

# Match indices of "Sample ID" in "janssen" with "TUBE ID LVL" in "shipment"
matching_indices <- match(janssen$`Sample ID`, shipment$`TUBE ID LVL `)

# Filter "janssen" dataframe based on matching indices
janssen <- janssen[!is.na(matching_indices), ]

# Remove rows from 1 to 19 in the "shipment" dataframe
shipment <- shipment %>% slice(20:n())

# Add the "ID" column from "shipment" to "janssen"
janssen$ID <- shipment$ID

# Extract ParticipantID from ID column
janssen <- janssen %>%
  mutate(ParticipantID = sub("_.*", "", ID))

# Create new dataframe "new_jan" with BL and FU columns
new_jan <- janssen %>%
  group_by(ParticipantID) %>%
  summarise(
    ptau217_plasmaNF_SimoaJanssen_BL = `Dilution Corrected Conc. (pg/mL)`[grepl("_V1$", ID)],
    ptau217_plasmaNF_SimoaJanssen_FU = `Dilution Corrected Conc. (pg/mL)`[grepl("_V2$", ID)]
  )
remove(janssen, shipment)

new_jan$ptau217_plasmaNF_SimoaJanssen_BL <- as.numeric(new_jan$ptau217_plasmaNF_SimoaJanssen_BL)
new_jan$ptau217_plasmaNF_SimoaJanssen_FU <- as.numeric(new_jan$ptau217_plasmaNF_SimoaJanssen_FU)

# Merge df with new_jan by ParticipantID
df <- merge(df, new_jan, by = "ParticipantID", all.x = TRUE)

df %>% dplyr::select("ParticipantID", "ptau217_plasmaNF_SimoaJanssen_BL", "ptau217_plasmaNF_SimoaJanssen_FU")
```

### Subset dataframe with variables of interest
```{r subset}

biomark_variables <- c(
  "ParticipantID",
  "Age_V1S1",
  "Sex",
  "APOE_binary",                           
  "APOE_class",
  "APOE_consensus",
  "A_status_BL",                           
  "T_status_BL",                          
  "AT_status_BL",
  "ATN_status_BL",
  "V1S1_dt",
  "V2S1_dt",
  "amyloid_PET_CL_BL_complete",
  "amyloid_PET_Centiloid_BL",
  "Ab42_CSFNC_RocheNTK_BL",
  "Ab40_CSFNC_RocheNTK_BL",
  "Ab40_plasmaF_SimoaNP4E_BL",
  "Ab42_40_ratio_plasmaF_SimoaNP4E_BL",
  "Ab42_plasmaF_SimoaNP4E_BL",
  "ptau181_plasmaF_Simoa_BL",              
  "ptau217_plasmaF_MSDLilly_BL",
  "ptau217_plasmaNF_SimoaJanssen_BL",
  "ptau231_plasmaF_SimoaGot_BL",
  "ttau_plasmaF_MSDLilly_BL",
  "GFAP_plasmaF_SimoaNP4E_BL",
  "NFL_plasmaF_SimoaNP4E_BL"
)

# Subset the data for the selected variables
biomark_df <- df[, biomark_variables]

# Create the ab42_40_ratio_CSFNC_BL proxy variable
biomark_df$ab42_40_ratio_CSFNC_BL <- biomark_df$Ab42_CSFNC_RocheNTK_BL/biomark_df$Ab40_CSFNC_RocheNTK_BL

# Change data type of interest variables
biomark_df$Age_V1S1 <- as.numeric(biomark_df$Age_V1S1)
biomark_df$Sex <- as.factor(biomark_df$Sex)
biomark_df$APOE_binary <- as.factor(biomark_df$APOE_binary)

baseline_cols <- c("Ab40_plasmaF_SimoaNP4E_BL","Ab42_40_ratio_plasmaF_SimoaNP4E_BL",
"Ab42_plasmaF_SimoaNP4E_BL","ptau181_plasmaF_Simoa_BL", "ptau217_plasmaF_MSDLilly_BL", "ptau217_plasmaNF_SimoaJanssen_BL","ptau231_plasmaF_SimoaGot_BL", "ttau_plasmaF_MSDLilly_BL", "GFAP_plasmaF_SimoaNP4E_BL", "NFL_plasmaF_SimoaNP4E_BL")


# Summarize the demographic data
demographic_summary <- biomark_df %>%
  summarise(
    Total_Participants = n(),
    Mean_Age = mean(Age_V1S1, na.rm = TRUE),
    SD_Age = sd(Age_V1S1, na.rm = TRUE),
    
    Male_Count = sum(Sex == 1, na.rm = TRUE),
    Female_Count = sum(Sex == 2, na.rm = TRUE),
    
    Mean_Age_Male = mean(Age_V1S1[Sex == 1], na.rm = TRUE),
    SD_Age_Male = sd(Age_V1S1[Sex == 1], na.rm = TRUE),
    
    Mean_Age_Female = mean(Age_V1S1[Sex == 2], na.rm = TRUE),
    SD_Age_Female = sd(Age_V1S1[Sex == 2], na.rm = TRUE),
    
    APOE_No_Risk = sum(APOE_binary == 0, na.rm = TRUE),
    APOE_At_Risk = sum(APOE_binary == 1, na.rm = TRUE),
    
    Mean_Age_APOE_No_Risk = mean(Age_V1S1[APOE_binary == 0], na.rm = TRUE),
    SD_Age_APOE_No_Risk = sd(Age_V1S1[APOE_binary == 0], na.rm = TRUE),
    
    Mean_Age_APOE_At_Risk = mean(Age_V1S1[APOE_binary == 1], na.rm = TRUE),
    SD_Age_APOE_At_Risk = sd(Age_V1S1[APOE_binary == 1], na.rm = TRUE),
    
    A_Status_Positive = sum(A_status_BL == "A+", na.rm = TRUE),
    A_Status_Negative = sum(A_status_BL == "A-", na.rm = TRUE),
    
    Mean_Age_A_Status_Positive = mean(Age_V1S1[A_status_BL == "A+"], na.rm = TRUE),
    SD_Age_A_Status_Positive = sd(Age_V1S1[A_status_BL == "A+"], na.rm = TRUE),
    
    Mean_Age_A_Status_Negative = mean(Age_V1S1[A_status_BL == "A-"], na.rm = TRUE),
    SD_Age_A_Status_Negative = sd(Age_V1S1[A_status_BL == "A-"], na.rm = TRUE)
  )

# Print the demographic summary table
print(t((demographic_summary)))


```


### Cross sectional EDA

```{r}

baseline_data <- biomark_df[, c("ParticipantID", baseline_cols)]

# Step 1: Summary Statistics
summary_stats_baseline <- apply(baseline_data[, baseline_cols], 2, function(x) c(mean = mean(x, na.rm = TRUE), median = median(x, na.rm = TRUE), sd = sd(x, na.rm = TRUE)))

# Print summary statistics for baseline biomarkers
print(summary_stats_baseline)

# Step 2: Visualize Distributions
for (i in 1:length(baseline_cols)) {
  hist(baseline_data[, baseline_cols[i]], main = paste("Baseline", baseline_cols[i]), xlab = "Value", col = "skyblue", na.rm = TRUE)
}

# Step 3: Examine Correlations
correlation_matrix_baseline <- cor(baseline_data[, baseline_cols], use = "complete.obs")

correlation_matrix_baseline

# Plot correlation matrix for baseline with axis labels
image(correlation_matrix_baseline, 
      main = "Correlation Matrix (Baseline)", 
      xlab = "Biomarkers (Baseline)", 
      ylab = "Biomarkers (Baseline)",
      col = colorRampPalette(c("blue", "white", "red"))(100))





```

### Baseline linear regression

```{r}
## Linear regression

# Regression against Age and Sex
perform_mult_regression <- function(data, dependent_variable, covariates) {
  # Create a formula for regression
  formula <- as.formula(paste(dependent_variable, "~", paste(covariates, collapse = "+")))
  
  # Fit linear regression model
  model <- lm(formula, data = data, na.action = 'na.exclude')
  
  # Store the model in a list
  result <- list(
    dependent_variable = dependent_variable,
    model = model,
    summary_result = summary(model)
  )
  
  return(result)
}

covariates <- c("Age_V1S1", "Sex")

# Create an list to store the models
baseline_mult_models <- vector("list", length = 10)

# Apply the function for each variable in difference_cols
for (i in seq_along(baseline_cols)) {
  variable <- baseline_cols[i]
  model_result <- perform_mult_regression(biomark_df, variable, covariates)
  
  # Store the model result in the list
  baseline_mult_models[[i]] <- model_result
}


```


### Amyloid PET reference group

```{r}

## Quantile 10
quantile(biomark_df$amyloid_PET_CL_BL_complete, probs = 0.10, na.rm = TRUE) #-11.7253531

## Amyiloid group

# Create an empty list to store the results
residuals_amyloid_summary <- list()

# Loop through each model in the list
for (i in seq_along(baseline_mult_models)) {
  model <- baseline_mult_models[[i]]$model
  
  # Extract residuals for samples with amyloid_PET_CL_BL_complete < -11.7253531
  residuals_subset <- residuals(model)[biomark_df$amyloid_PET_CL_BL_complete < -11.7253531]
  
  # Calculate mean and standard deviation of residuals subset
  residuals_mean <- mean(residuals_subset, na.rm = TRUE)
  residuals_sd <- sd(residuals_subset, na.rm = TRUE)
  
  # Store the mean and sd in the results list
  residuals_amyloid_summary[[i]] <- list(
    model_name = baseline_mult_models[[i]]$dependent_variable,
    residuals_mean = residuals_mean,
    residuals_sd = residuals_sd
  )
  
  # Add mean and sd as new columns in biomark_df
  biomark_df[paste0("amyloid_mean_", baseline_mult_models[[i]]$dependent_variable)] <- residuals_mean
  biomark_df[paste0("amyloid_sd_", baseline_mult_models[[i]]$dependent_variable)] <- residuals_sd
}

# Convert the results list to a data frame
amyloid_summary_df <- do.call(rbind, residuals_amyloid_summary)


```


### Compute z-scores using PET amyloid reference group

```{r}
# Function to compute z-scores for a list of models
compute_z_scores_PET <- function(model_list, data) {
  # Loop through each model in the list
  for (i in seq_along(model_list)) {
    model <- model_list[[i]]$model
    variable <- model_list[[i]]$dependent_variable
    
      # Extract the residuals from the model
      residuals <- residuals(model)
      
      # Get mean and standard deviation from the corresponding columns in the data frame
      mean_col <- paste("amyloid_mean_", variable, sep = "")
      sd_col <- paste( "amyloid_sd_", variable, sep = "")
      mean_val <- data[[mean_col]][1]
      sd_val <- data[[sd_col]][1]
      
      # Scale residuals by the mean and standard deviation
      z_scores <- scale(residuals, center = mean_val, scale = sd_val)
      
      # Create a new column in the data frame for the scaled z-scores
      z_score_col <- paste(variable, "_z_score_PET", sep = "")
      
      # Update the data frame with the z_scores
      data <- data %>%
      mutate(!!z_score_col := z_scores)
    
  }
  
  return(data)
}

# Apply the function for each list of models
biomark_df <- compute_z_scores_PET(baseline_mult_models, biomark_df)

### Plot of PET amyloid z-scores against proxies

# Z_score variables
z_score_PET <- c("Ab40_plasmaF_SimoaNP4E_BL_z_score_PET", "Ab42_40_ratio_plasmaF_SimoaNP4E_BL_z_score_PET", "Ab42_plasmaF_SimoaNP4E_BL_z_score_PET", "ptau181_plasmaF_Simoa_BL_z_score_PET", "ptau217_plasmaF_MSDLilly_BL_z_score_PET", "ptau217_plasmaNF_SimoaJanssen_BL_z_score_PET", "ptau231_plasmaF_SimoaGot_BL_z_score_PET", "ttau_plasmaF_MSDLilly_BL_z_score_PET",  "GFAP_plasmaF_SimoaNP4E_BL_z_score_PET","NFL_plasmaF_SimoaNP4E_BL_z_score_PET")

# Define a color palette for z_score variables
color_palette <- rainbow(length(z_score_PET))


# Select the columns to be multiplied by -1
columns_to_multiply <- c("Ab42_40_ratio_plasmaF_SimoaNP4E_BL_z_score_PET", "Ab42_plasmaF_SimoaNP4E_BL_z_score_PET")

# Multiply the selected columns by -1
biomark_df[, columns_to_multiply] <- biomark_df[, columns_to_multiply] * -1


```


### Individual biomarkers plot
```{r}

## Single plots

# Create a data frame to store the response variable names
plot_data <- data.frame(z_score_var = rep(z_score_PET, each = nrow(biomark_df)),
                        amyloid_PET_CL_BL_complete = rep(biomark_df$amyloid_PET_CL_BL_complete, times = length(z_score_PET)),
                        value = as.vector(sapply(z_score_PET, function(z_var) biomark_df[[z_var]])))

### Amyloid proxy different plots

# Plot ggplot with loess smoothing for each z_score variable
facet_plot <- ggplot(plot_data, aes(x = amyloid_PET_CL_BL_complete, y = value, color = z_score_var)) +
  geom_smooth(method = "loess", span = 0.9, aes(fill = z_score_var), alpha = 0.1) +
  labs(title = "Amyloid reference group and Amyloid PET BL as proxy",
       x = "amyloid_PET_CL_BL_complete",
       y = "Baseline levels") +
  scale_color_manual(values = setNames(color_palette, z_score_PET)) +
  theme_minimal() +
  facet_wrap(~ z_score_var, scales = "free_y")

# Convert ggplot to Plotly
facet_amyloid <- ggplotly(facet_plot)

# Print the Plotly plot
print(facet_amyloid)

```


### Combined biomarkers plot
```{r}
## Combined plots

# Create a data frame to store the response variable names
plot_data <- data.frame(z_score_var = rep(z_score_PET, each = nrow(biomark_df)),
                        amyloid_PET_CL_BL_complete = rep(biomark_df$amyloid_PET_CL_BL_complete, times = length(z_score_PET)),
                        value = as.vector(sapply(z_score_PET, function(z_var) biomark_df[[z_var]])))

# Plot ggplot with loess smoothing for each z_score variable
combined_plot <- ggplot(plot_data, aes(x = amyloid_PET_CL_BL_complete, y = value, color = z_score_var)) +
  geom_smooth(method = "loess", linetype = 2, span = 0.9, se = FALSE, aes(fill = z_score_var), alpha = 0.1) +
  geom_hline(yintercept = 2, linetype = "solid", alpha = 0.5) +  
  geom_vline(xintercept = 12, linetype = "dotted", alpha = 0.5, color = 'red') +
  annotate("text", x = -20, y = 2.2, label = "2 s.d.", size = 3, fontface = 'bold') +
  labs(title = "Amyloid reference group",
       x = "amyloid_PET_CL_BL_complete",
       y = "Baseline z-scores") +
  scale_color_manual(values = setNames(color_palette, z_score_PET)) +
  theme_minimal()


# Convert ggplot to plotly plot
combined_amyloid <- ggplotly(combined_plot)

# Print the interactive plot
combined_amyloid

```

### Bootstrapping
```{r}

# Function to fit loess model and calculate coefficients
loess_fit <- function(formula, data, indices) {
  d <- data[indices, ]
  fit <- loess(formula, data = d)
  pred <- predict(fit, newdata = data)
  return(pred)
}

# Bootstrap function to obtain coefficients for each variable
bootstrap_loess_coef <- function(data, formula, nboot = 1000) {
  boot_res <- boot(data, statistic = loess_fit, R = nboot, formula = formula)
  return(boot_res)
}

# List to store bootstrapped coefficients for each variable
boot_results <- list()

# Loop through each variable and perform bootstrapping
for (variable in z_score_PET) {
  data <- biomark_df[, c("amyloid_PET_CL_BL_complete", variable)]
  boot_results[[variable]] <- bootstrap_loess_coef(data = data, formula = as.formula(paste(variable, "~ amyloid_PET_CL_BL_complete")))
}

# Access bootstrapped coefficients for each variable
for (variable in z_score_PET) {
  cat("Bootstrapped coefficients for", variable, ":\n")
}

# Initialize a list to store averaged predictions for each variable
averaged_predictions <- list()

# Loop through each variable to calculate averaged predictions
for (variable in z_score_PET) {
  cat("Calculating averaged predictions for", variable, ":\n")
  
  # Initialize an empty vector to store predictions from each iteration
  predictions <- numeric(nrow(biomark_df))
  
  # Extract predictions from each iteration and aggregate them
  for (i in 1:1000) {
    predictions <- predictions + boot_results[[variable]]$t[i,]
  }
  
  # Calculate the average prediction across all iterations
  averaged_predictions[[variable]] <- predictions / 1000
  
  # Print the averaged predictions for each variable
  cat("Averaged predictions for", variable, ":\n")
}

averaged_predictions <- as.data.frame(averaged_predictions)

averaged_predictions$amyloid_PET_CL_BL_complete  <- biomark_df$amyloid_PET_CL_BL_complete


```


```{r}
# Combined bootstrap plot
gg <- ggplot(data = averaged_predictions, aes(x = amyloid_PET_CL_BL_complete)) +
  geom_smooth(aes(y = Ab40_plasmaF_SimoaNP4E_BL_z_score_PET, color = "Ab40"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = Ab42_40_ratio_plasmaF_SimoaNP4E_BL_z_score_PET, color = "Ab42_40_ratio"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = Ab42_plasmaF_SimoaNP4E_BL_z_score_PET, color = "Ab42"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau181_plasmaF_Simoa_BL_z_score_PET, color = "ptau181"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau217_plasmaF_MSDLilly_BL_z_score_PET, color = "ptau217_MSDLilly"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau217_plasmaNF_SimoaJanssen_BL_z_score_PET, color = "ptau217_SimoaJanssen"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau231_plasmaF_SimoaGot_BL_z_score_PET, color = "ptau231"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ttau_plasmaF_MSDLilly_BL_z_score_PET, color = "ttau_MSDLilly"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = GFAP_plasmaF_SimoaNP4E_BL_z_score_PET, color = "GFAP"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = NFL_plasmaF_SimoaNP4E_BL_z_score_PET, color = "NFL"), 
              se = FALSE, method = "loess", linetype = 2) +
  labs(title = "Average of Bootstraps Amyloid PET",
       x = "amyloid_PET_CL_BL_complete",
       y = "Bootstraps average of z-score baseline",
       color = "Biomarker") +
  geom_hline(yintercept = 2, linetype = "solid", alpha = 0.5) +  
  geom_vline(xintercept = 12, linetype = "dotted", alpha = 0.5, color = 'red') +
  theme_minimal()

# Convert ggplot to plotly
plotly_plot <- ggplotly(gg)

# Print the plotly plot
plotly_plot

```


```{r}
# Combined original plot
gg2 <- ggplot(data = biomark_df, aes(x = amyloid_PET_CL_BL_complete)) +
  geom_smooth(aes(y = Ab40_plasmaF_SimoaNP4E_BL_z_score_PET, color = "Ab40"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = Ab42_40_ratio_plasmaF_SimoaNP4E_BL_z_score_PET, color = "Ab42_40_ratio"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = Ab42_plasmaF_SimoaNP4E_BL_z_score_PET, color = "Ab42"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau181_plasmaF_Simoa_BL_z_score_PET, color = "ptau181"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau217_plasmaF_MSDLilly_BL_z_score_PET, color = "ptau217_MSDLilly"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau217_plasmaNF_SimoaJanssen_BL_z_score_PET, color = "ptau217_SimoaJanssen"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau231_plasmaF_SimoaGot_BL_z_score_PET, color = "ptau231"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ttau_plasmaF_MSDLilly_BL_z_score_PET, color = "ttau_MSDLilly"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = GFAP_plasmaF_SimoaNP4E_BL_z_score_PET, color = "GFAP"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = NFL_plasmaF_SimoaNP4E_BL_z_score_PET, color = "NFL"), 
              se = FALSE, method = "loess", linetype = 2) +
  labs(title = "Original Amyiloid PET reference group  ",
       x = "amyloid_PET_CL_BL_complete",
       y = "z-scores Baseline",
       color = "Variable") +
  geom_hline(yintercept = 2, linetype = "solid", alpha = 0.5) +  
  geom_vline(xintercept = 12, linetype = "dotted", alpha = 0.5, color = 'red') +
  theme_minimal()

# Convert ggplot to plotly
plotly_plot2 <- ggplotly(gg2)

# Print the plotly plot
plotly_plot2

```

## Bootstrapping using median
```{r}
# Function to fit loess model and calculate coefficients
loess_fit <- function(formula, data, indices) {
  d <- data[indices, ]
  fit <- loess(formula, data = d)
  pred <- predict(fit, newdata = data)
  return(pred)
}

# Bootstrap function to obtain coefficients for each variable
bootstrap_loess_coef <- function(data, formula, nboot = 1000) {
  boot_res <- boot(data, statistic = loess_fit, R = nboot, formula = formula)
  return(boot_res)
}

# List to store bootstrapped coefficients for each variable
boot_results <- list()

# Loop through each variable and perform bootstrapping
for (variable in z_score_PET) {
  data <- biomark_df[, c("amyloid_PET_CL_BL_complete", variable)]
  boot_results[[variable]] <- bootstrap_loess_coef(data = data, formula = as.formula(paste(variable, "~ amyloid_PET_CL_BL_complete")))
}

# Access bootstrapped coefficients for each variable
for (variable in z_score_PET) {
  cat("Bootstrapped coefficients for", variable, ":\n")
}


# Initialize a list to store median predictions for each variable for each iteration
median_predictions <- list()

# Loop through each variable to calculate median predictions for each iteration
for (variable in z_score_PET) {
  cat("Calculating median predictions for", variable, ":\n")
  
  # Initialize a matrix to store predictions from each iteration
  iteration_predictions <- matrix(NA, nrow = nrow(biomark_df), ncol = 1000)
  
  # Extract predictions from each iteration and store them in the matrix
  for (i in 1:1000) {
    iteration_predictions[, i] <- boot_results[[variable]]$t[i,]
  }
  
  # Calculate the median prediction for each variable across all iterations
  median_predictions[[variable]] <- apply(iteration_predictions, 1, median)
  
  # Print the median predictions for each variable
  cat("Median predictions for", variable, "calculated.\n")
}

median_predictions <- as.data.frame(median_predictions)

median_predictions$amyloid_PET_CL_BL_complete  <- biomark_df$amyloid_PET_CL_BL_complete
```



```{r}
# Combined bootstrap plot
gg <- ggplot(data = median_predictions, aes(x = amyloid_PET_CL_BL_complete)) +
  geom_smooth(aes(y = Ab40_plasmaF_SimoaNP4E_BL_z_score_PET, color = "Ab40"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = Ab42_40_ratio_plasmaF_SimoaNP4E_BL_z_score_PET, color = "Ab42_40_ratio"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = Ab42_plasmaF_SimoaNP4E_BL_z_score_PET, color = "Ab42"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau181_plasmaF_Simoa_BL_z_score_PET, color = "ptau181"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau217_plasmaF_MSDLilly_BL_z_score_PET, color = "ptau217_MSDLilly"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau217_plasmaNF_SimoaJanssen_BL_z_score_PET, color = "ptau217_SimoaJanssen"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau231_plasmaF_SimoaGot_BL_z_score_PET, color = "ptau231"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ttau_plasmaF_MSDLilly_BL_z_score_PET, color = "ttau_MSDLilly"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = GFAP_plasmaF_SimoaNP4E_BL_z_score_PET, color = "GFAP"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = NFL_plasmaF_SimoaNP4E_BL_z_score_PET, color = "NFL"), 
              se = FALSE, method = "loess", linetype = 2) +
  labs(title = "Median of Bootstraps Amyloid PET",
       x = "amyloid_PET_CL_BL_complete",
       y = "Bootstraps average of z-score baseline",
       color = "Biomarker") +
  geom_hline(yintercept = 2, linetype = "solid", alpha = 0.5) +  
  geom_vline(xintercept = 12, linetype = "dotted", alpha = 0.5, color = 'red') +
  theme_minimal()

# Convert ggplot to plotly
plotly_plot <- ggplotly(gg)

# Print the plotly plot
plotly_plot
```


### CSF AB 42/40 ratio reference group
```{r}

# Quantile 90
quantile(biomark_df$ab42_40_ratio_CSFNC_BL, probs = 0.90, na.rm = TRUE) #0.09721704

# Create an empty list to store the results
residuals_CSF_summary <- list()

# Loop through each model in the list
for (i in seq_along(baseline_mult_models)) {
  model <- baseline_mult_models[[i]]$model
  
  # Extract residuals for samples with ab42_40_ratio_CSFNC_BL > 0.09721704
  residuals_subset <- residuals(model)[biomark_df$ab42_40_ratio_CSFNC_BL > 0.09721704]
  
  # Calculate mean and standard deviation of residuals subset
  residuals_mean <- mean(residuals_subset, na.rm = TRUE)
  residuals_sd <- sd(residuals_subset, na.rm = TRUE)
  
  # Store the mean and sd in the results list
  residuals_CSF_summary[[i]] <- list(
    model_name = baseline_mult_models[[i]]$dependent_variable,
    residuals_mean = residuals_mean,
    residuals_sd = residuals_sd
  )
  
  # Add mean and sd as new columns in biomark_df
  biomark_df[paste0("CSF_mean_", baseline_mult_models[[i]]$dependent_variable)] <- residuals_mean
  biomark_df[paste0("CSF_sd_", baseline_mult_models[[i]]$dependent_variable)] <- residuals_sd
}

# Convert the results list to a data frame
CSF_summary_df <- do.call(rbind, residuals_CSF_summary)
```


### Compute z-scores using CSF AB 42/40 ratio reference group

```{r}
# Function to compute z-scores for a list of models
compute_z_scores_CSF <- function(model_list, data) {
  # Loop through each model in the list
  for (i in seq_along(model_list)) {
    model <- model_list[[i]]$model
    variable <- model_list[[i]]$dependent_variable
    
      # Extract the residuals from the model
      residuals <- residuals(model)
      
      # Get mean and standard deviation from the corresponding columns in the data frame
      mean_col <- paste("CSF_mean_", variable, sep = "")
      sd_col <- paste( "CSF_sd_", variable, sep = "")
      mean_val <- data[[mean_col]][1]
      sd_val <- data[[sd_col]][1]
      
      # Scale residuals by the mean and standard deviation
      z_scores <- scale(residuals, center = mean_val, scale = sd_val)
      
      # Create a new column in the data frame for the scaled z-scores
      z_score_col <- paste(variable, "_z_score_CSF", sep = "")
      
      # Update the data frame with the z_scores
      data <- data %>%
      mutate(!!z_score_col := z_scores)
    
  }
  
  return(data)
}

# Apply the function for each list of models
biomark_df <- compute_z_scores_CSF(baseline_mult_models, biomark_df)

# List of CSF z_score variables
z_score_CSF <- c("Ab40_plasmaF_SimoaNP4E_BL_z_score_CSF", "Ab42_40_ratio_plasmaF_SimoaNP4E_BL_z_score_CSF", "Ab42_plasmaF_SimoaNP4E_BL_z_score_CSF", "ptau181_plasmaF_Simoa_BL_z_score_CSF", "ptau217_plasmaF_MSDLilly_BL_z_score_CSF", "ptau217_plasmaNF_SimoaJanssen_BL_z_score_CSF", "ptau231_plasmaF_SimoaGot_BL_z_score_CSF", "ttau_plasmaF_MSDLilly_BL_z_score_CSF",  "GFAP_plasmaF_SimoaNP4E_BL_z_score_CSF","NFL_plasmaF_SimoaNP4E_BL_z_score_CSF")

# Color palette for z_score variables
color_palette <- rainbow(length(z_score_CSF))

# Select the columns to be multiplied by -1
columns_to_multiply <- c("Ab42_40_ratio_plasmaF_SimoaNP4E_BL_z_score_CSF", "Ab42_plasmaF_SimoaNP4E_BL_z_score_CSF")

# Multiply the selected columns by -1
biomark_df[, columns_to_multiply] <- biomark_df[, columns_to_multiply] * -1



```
 

### Individual biomarkers plot
```{r}
# Create a data frame to store the response variable names
plot_data <- data.frame(z_score_var = rep(z_score_CSF, each = nrow(biomark_df)),
                        ab42_40_ratio_CSFNC_BL = rep(biomark_df$ab42_40_ratio_CSFNC_BL, times = length(z_score_CSF)),
                        value = as.vector(sapply(z_score_CSF, function(z_var) biomark_df[[z_var]])))

### Amyloid proxy different plots

# Plot ggplot with loess smoothing for each z_score variable
facet_plot <- ggplot(plot_data, aes(x = ab42_40_ratio_CSFNC_BL, y = value, color = z_score_var)) +
  geom_smooth(method = "loess", span = 0.9, aes(fill = z_score_var), alpha = 0.1) +
  labs(title = "CSF reference group using CSF AB 42/40 ratio as proxy",
       x = "ab42_40_ratio_CSFNC_BL",
       y = "Baseline levels") +
  scale_color_manual(values = setNames(color_palette, z_score_CSF)) +
  scale_x_continuous(trans = "reverse") + # Invert x-axis 
  theme_minimal() +
  facet_wrap(~ z_score_var, scales = "free_y")

# Convert ggplot to interactive plot using ggplotly
facet_CSF <- ggplotly(facet_plot)

# Print the interactive plot
print(facet_CSF)


```


### Combined biomarkers plot
```{r}

# Combined plot

# Create a data frame to store the response variable names
plot_data <- data.frame(z_score_var = rep(z_score_CSF, each = nrow(biomark_df)),
                        ab42_40_ratio_CSFNC_BL = rep(biomark_df$ab42_40_ratio_CSFNC_BL, times = length(z_score_CSF)),
                        value = as.vector(sapply(z_score_CSF, function(z_var) biomark_df[[z_var]])))

# Plot ggplot with loess smoothing for each z_score variable
combined_plot <- ggplot(plot_data, aes(x = ab42_40_ratio_CSFNC_BL, y = value, color = z_score_var)) +
  geom_smooth(method = "loess", linetype = 2, span = 0.9, aes(fill = z_score_var), alpha = 0.1, se = FALSE) +
  geom_hline(yintercept = 2, linetype = "solid", alpha = 0.5) +  
  geom_vline(xintercept = 0.071, linetype = "dotted", alpha = 0.5, color = 'red') +
  annotate("text", x = 0.12, y = 2.2, label = "2 s.d.", size = 3, fontface = 'bold') +
  labs(title = "CSF reference group",
       x = "ab42/40 ratio CSFNC Baseline",
       y = "Baseline z-scores") +
  scale_color_manual(values = setNames(color_palette, z_score_CSF)) +
  theme_minimal() +
  scale_x_continuous(trans = "reverse")  # Invert x-axis

# Convert ggplot to interactive plot using ggplotly
combined_CSF <- ggplotly(combined_plot)

# Print the interactive plot
print(combined_CSF)


```

### Bootstrapping
```{r}

# Function to fit loess model and calculate coefficients
loess_fit <- function(formula, data, indices) {
  d <- data[indices, ]
  fit <- loess(formula, data = d)
  pred <- predict(fit, newdata = data)
  return(pred)
}

# Bootstrap function to obtain coefficients for each variable
bootstrap_loess_coef <- function(data, formula, nboot = 1000) {
  boot_res <- boot(data, statistic = loess_fit, R = nboot, formula = formula)
  return(boot_res)
}

# List to store bootstrapped coefficients for each variable
boot_results <- list()

# Loop through each variable and perform bootstrapping
for (variable in z_score_CSF) {
  data <- biomark_df[, c("ab42_40_ratio_CSFNC_BL", variable)]
  boot_results[[variable]] <- bootstrap_loess_coef(data = data, formula = as.formula(paste(variable, "~ ab42_40_ratio_CSFNC_BL")))
}

# Access bootstrapped coefficients for each variable
for (variable in z_score_CSF) {
  cat("Bootstrapped coefficients for", variable, ":\n")
}

# Initialize a list to store averaged predictions for each variable
averaged_predictions <- list()

# Loop through each variable to calculate averaged predictions
for (variable in z_score_CSF) {
  cat("Calculating averaged predictions for", variable, ":\n")
  
  # Initialize an empty vector to store predictions from each iteration
  predictions <- numeric(nrow(biomark_df))
  
  # Extract predictions from each iteration and aggregate them
  for (i in 1:1000) {
    predictions <- predictions + boot_results[[variable]]$t[i,]
  }
  
  # Calculate the average prediction across all iterations
  averaged_predictions[[variable]] <- predictions / 1000
  
  
}

averaged_predictions <- as.data.frame(averaged_predictions)

averaged_predictions$ab42_40_ratio_CSFNC_BL  <- biomark_df$ab42_40_ratio_CSFNC_BL


```



```{r}
# Combined bootstrap plot
gg <- ggplot(data = averaged_predictions, aes(x = ab42_40_ratio_CSFNC_BL)) +
  geom_smooth(aes(y = Ab40_plasmaF_SimoaNP4E_BL_z_score_CSF, color = "Ab40"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = Ab42_40_ratio_plasmaF_SimoaNP4E_BL_z_score_CSF, color = "Ab42_40_ratio"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = Ab42_plasmaF_SimoaNP4E_BL_z_score_CSF, color = "Ab42"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau181_plasmaF_Simoa_BL_z_score_CSF, color = "ptau181"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau217_plasmaF_MSDLilly_BL_z_score_CSF, color = "ptau217_MSDLilly"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau217_plasmaNF_SimoaJanssen_BL_z_score_CSF, color = "ptau217_SimoaJanssen"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau231_plasmaF_SimoaGot_BL_z_score_CSF, color = "ptau231"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ttau_plasmaF_MSDLilly_BL_z_score_CSF, color = "ttau_MSDLilly"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = GFAP_plasmaF_SimoaNP4E_BL_z_score_CSF, color = "GFAP"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = NFL_plasmaF_SimoaNP4E_BL_z_score_CSF, color = "NFL"), 
              se = FALSE, method = "loess", linetype = 2) +
  labs(title = "Average of Bootstraps for CSF reference group",
       x = "ab42/40 ratio CSFNC Baseline",
       y = "Average of z-score baseline bootstraps",
       color = "Variable") +
  geom_hline(yintercept = 2, linetype = "solid", alpha = 0.5) +  
  geom_vline(xintercept = 0.071, linetype = "dotted", alpha = 0.5, color = 'red') +
  scale_x_continuous(trans = "reverse") +
  theme_minimal()

# Convert ggplot to plotly
plotly_plot <- ggplotly(gg)

# Print the plotly plot
plotly_plot
```


```{r}
# Combined original plot
gg2 <- ggplot(data = biomark_df, aes(x = ab42_40_ratio_CSFNC_BL)) +
  geom_smooth(aes(y = Ab40_plasmaF_SimoaNP4E_BL_z_score_CSF, color = "Ab40"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = Ab42_40_ratio_plasmaF_SimoaNP4E_BL_z_score_CSF, color = "Ab42_40_ratio"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = Ab42_plasmaF_SimoaNP4E_BL_z_score_CSF, color = "Ab42"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau181_plasmaF_Simoa_BL_z_score_CSF, color = "ptau181"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau217_plasmaF_MSDLilly_BL_z_score_CSF, color = "ptau217_MSDLilly"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau217_plasmaNF_SimoaJanssen_BL_z_score_CSF, color = "ptau217_SimoaJanssen"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau231_plasmaF_SimoaGot_BL_z_score_CSF, color = "ptau231"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ttau_plasmaF_MSDLilly_BL_z_score_CSF, color = "ttau_MSDLilly"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = GFAP_plasmaF_SimoaNP4E_BL_z_score_CSF, color = "GFAP"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = NFL_plasmaF_SimoaNP4E_BL_z_score_CSF, color = "NFL"), 
              se = FALSE, method = "loess", linetype = 2) +
  labs(title = "Original CSF reference group  ",
       x = "ab42/40 ratio CSFNC Baseline",
       y = "z-scores Baseline",
       color = "Variable") +
  geom_hline(yintercept = 2, linetype = "solid", alpha = 0.5) +  
  geom_vline(xintercept = 0.071, linetype = "dotted", alpha = 0.5, color = 'red') +
  scale_x_continuous(trans = "reverse") +
  theme_minimal()

# Convert ggplot to plotly
plotly_plot2 <- ggplotly(gg2)

# Print the plotly plot
plotly_plot2

```


## Bootstrapping using median
```{r}
# Function to fit loess model and calculate coefficients
loess_fit <- function(formula, data, indices) {
  d <- data[indices, ]
  fit <- loess(formula, data = d)
  pred <- predict(fit, newdata = data)
  return(pred)
}

# Bootstrap function to obtain coefficients for each variable
bootstrap_loess_coef <- function(data, formula, nboot = 1000) {
  boot_res <- boot(data, statistic = loess_fit, R = nboot, formula = formula)
  return(boot_res)
}

# List to store bootstrapped coefficients for each variable
boot_results <- list()

# Loop through each variable and perform bootstrapping
for (variable in z_score_CSF) {
  data <- biomark_df[, c("ab42_40_ratio_CSFNC_BL", variable)]
  boot_results[[variable]] <- bootstrap_loess_coef(data = data, formula = as.formula(paste(variable, "~ ab42_40_ratio_CSFNC_BL")))
}

# Access bootstrapped coefficients for each variable
for (variable in z_score_CSF) {
  cat("Bootstrapped coefficients for", variable, ":\n")
}


# Initialize a list to store median predictions for each variable for each iteration
median_predictions <- list()

# Loop through each variable to calculate median predictions for each iteration
for (variable in z_score_CSF) {
  cat("Calculating median predictions for", variable, ":\n")
  
  # Initialize a matrix to store predictions from each iteration
  iteration_predictions <- matrix(NA, nrow = nrow(biomark_df), ncol = 1000)
  
  # Extract predictions from each iteration and store them in the matrix
  for (i in 1:1000) {
    iteration_predictions[, i] <- boot_results[[variable]]$t[i,]
  }
  
  # Calculate the median prediction for each variable across all iterations
  median_predictions[[variable]] <- apply(iteration_predictions, 1, median)
  
  # Print the median predictions for each variable
  cat("Median predictions for", variable, "calculated.\n")
}

median_predictions <- as.data.frame(median_predictions)

median_predictions$ab42_40_ratio_CSFNC_BL  <- biomark_df$ab42_40_ratio_CSFNC_BL
```



```{r}
# Combined bootstrap plot
gg <- ggplot(data = median_predictions, aes(x = ab42_40_ratio_CSFNC_BL)) +
  geom_smooth(aes(y = Ab40_plasmaF_SimoaNP4E_BL_z_score_CSF, color = "Ab40"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = Ab42_40_ratio_plasmaF_SimoaNP4E_BL_z_score_CSF, color = "Ab42_40_ratio"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = Ab42_plasmaF_SimoaNP4E_BL_z_score_CSF, color = "Ab42"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau181_plasmaF_Simoa_BL_z_score_CSF, color = "ptau181"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau217_plasmaF_MSDLilly_BL_z_score_CSF, color = "ptau217_MSDLilly"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau217_plasmaNF_SimoaJanssen_BL_z_score_CSF, color = "ptau217_SimoaJanssen"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau231_plasmaF_SimoaGot_BL_z_score_CSF, color = "ptau231"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ttau_plasmaF_MSDLilly_BL_z_score_CSF, color = "ttau_MSDLilly"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = GFAP_plasmaF_SimoaNP4E_BL_z_score_CSF, color = "GFAP"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = NFL_plasmaF_SimoaNP4E_BL_z_score_CSF, color = "NFL"), 
              se = FALSE, method = "loess", linetype = 2) +
  labs(title = "Average of Bootstraps for Z-score Variables",
       x = "ab42/40 ratio CSFNC Baseline",
       y = "Average of z-score baseline bootstraps",
       color = "Variable") +
  geom_hline(yintercept = 2, linetype = "solid", alpha = 0.5) +  
  geom_vline(xintercept = 0.071, linetype = "dotted", alpha = 0.5, color = 'red') +
  scale_x_continuous(trans = "reverse") +
  theme_minimal()

# Convert ggplot to plotly
plotly_plot <- ggplotly(gg)

# Print the plotly plot
plotly_plot
```




### Age as proxy

```{r}

## Linear regression

# Regression against Sex
perform_mult_regression <- function(data, dependent_variable, covariates) {
  # Create a formula for regression
  formula <- as.formula(paste(dependent_variable, "~", paste(covariates, collapse = "+")))
  
  # Fit linear regression model
  model <- lm(formula, data = data, na.action = 'na.exclude')
  
  # Store the model in a list
  result <- list(
    dependent_variable = dependent_variable,
    model = model,
    summary_result = summary(model)
  )
  
  return(result)
}

covariates <- "Sex"

# Create an list to store the models
age_models <- vector("list", length = 10)

# Apply the function for each variable in difference_cols
for (i in seq_along(baseline_cols)) {
  variable <- baseline_cols[i]
  model_result <- perform_mult_regression(biomark_df, variable, covariates)
  
  # Store the model result in the list
  age_models[[i]] <- model_result
}
```



```{r}
## Quantile 10
quantile(biomark_df$Age_V1S1, probs = 0.10, na.rm = TRUE) # 54.31

# Create an empty list to store the results
age_residuals_summary <- list()

# Loop through each model in the list
for (i in seq_along(age_models)) {
  model <- age_models[[i]]$model
  
  # Extract residuals for samples with Age_V1S1 <= 54.31
  residuals_subset <- residuals(model)[biomark_df$Age_V1S1 < 54.31]
  
  # Calculate mean and standard deviation of residuals subset
  residuals_mean <- mean(residuals_subset, na.rm = TRUE)
  residuals_sd <- sd(residuals_subset, na.rm = TRUE)
  
  # Store the mean and sd in the results list
  age_residuals_summary[[i]] <- list(
    model_name = age_models[[i]]$dependent_variable,
    residuals_mean = residuals_mean,
    residuals_sd = residuals_sd
  )
  
  # Add mean and sd as new columns in biomark_df
  biomark_df[paste0("age_residuals_mean_", age_models[[i]]$dependent_variable)] <- residuals_mean
  biomark_df[paste0("age_residuals_sd_", age_models[[i]]$dependent_variable)] <- residuals_sd
}

# Convert the results list to a data frame
age_residuals_df <- do.call(rbind, age_residuals_summary)
```

```{r}
# Function to compute z-scores for a list of models
compute_z_scores_Age <- function(model_list, data) {
  # Loop through each model in the list
  for (i in seq_along(model_list)) {
    model <- model_list[[i]]$model
    variable <- model_list[[i]]$dependent_variable
    
      # Extract the residuals from the model
      residuals <- residuals(model)
      
      # Get mean and standard deviation from the corresponding columns in the data frame
      mean_col <- paste("age_residuals_mean_", variable, sep = "")
      sd_col <- paste( "age_residuals_sd_", variable, sep = "")
      mean_val <- data[[mean_col]][1]
      sd_val <- data[[sd_col]][1]
      
      # Scale residuals by the mean and standard deviation
      z_scores <- scale(residuals, center = mean_val, scale = sd_val)
      
      # Create a new column in the data frame for the scaled z-scores
      z_score_col <- paste(variable, "_z_score_Age", sep = "")
      
      # Update the data frame with the z_scores
      data <- data %>%
      mutate(!!z_score_col := z_scores)
    
  }
  
  return(data)
}

# Apply the function for each list of models
biomark_df <- compute_z_scores_Age(age_models, biomark_df)

### Plot of PET amyloid z-scores against proxies

# Your list of z_score variables and proxy variables
z_score_Age <- c("Ab40_plasmaF_SimoaNP4E_BL_z_score_Age", "Ab42_40_ratio_plasmaF_SimoaNP4E_BL_z_score_Age", "Ab42_plasmaF_SimoaNP4E_BL_z_score_Age", "ptau181_plasmaF_Simoa_BL_z_score_Age", "ptau217_plasmaF_MSDLilly_BL_z_score_Age", "ptau217_plasmaNF_SimoaJanssen_BL_z_score_Age", "ptau231_plasmaF_SimoaGot_BL_z_score_Age", "ttau_plasmaF_MSDLilly_BL_z_score_Age",  "GFAP_plasmaF_SimoaNP4E_BL_z_score_Age", "NFL_plasmaF_SimoaNP4E_BL_z_score_Age")

# Define a color palette for z_score variables
color_palette <- rainbow(length(z_score_Age))


# Select the columns to be multiplied by -1
columns_to_multiply <- c("Ab42_40_ratio_plasmaF_SimoaNP4E_BL_z_score_Age", "Ab42_plasmaF_SimoaNP4E_BL_z_score_Age")

# Multiply the selected columns by -1
biomark_df[, columns_to_multiply] <- biomark_df[, columns_to_multiply] * -1


```


```{r}
## Combined plots

# Create a data frame to store the response variable names
plot_data <- data.frame(z_score_var = rep(z_score_Age, each = nrow(biomark_df)),
                        Age_V1S1 = rep(biomark_df$Age_V1S1, times = length(z_score_Age)),
                        value = as.vector(sapply(z_score_Age, function(z_var) biomark_df[[z_var]])))

# Plot ggplot with loess smoothing for each z_score variable
combined_plot <- ggplot(plot_data, aes(x = Age_V1S1, y = value, color = z_score_var)) +
  geom_smooth(method = "loess", linetype = 2, span = 0.9, aes(fill = z_score_var), alpha = 0.1, se = FALSE) +
  geom_hline(yintercept = 2, linetype = "solid", alpha = 0.5) +  
  geom_vline(xintercept = 54.31, linetype = "dotted", alpha = 0.5, color = 'red') +
  annotate("text", x = 50, y = 2.1, label = "2 s.d.", size = 3, fontface = 'bold') +
  labs(title = "Age reference group",
       x = "Age V1S1",
       y = "Baseline z-scores") +
  scale_color_manual(values = setNames(color_palette, z_score_Age)) +
  theme_minimal()

# Convert ggplot to plotly plot
combined_amyloid_age <- ggplotly(combined_plot)

# Print the interactive plot
combined_amyloid_age

```


### Bootstrapping
```{r}

# Function to fit loess model and calculate coefficients
loess_fit <- function(formula, data, indices) {
  d <- data[indices, ]
  fit <- loess(formula, data = d)
  pred <- predict(fit, newdata = data)
  return(pred)
}

# Bootstrap function to obtain coefficients for each variable
bootstrap_loess_coef <- function(data, formula, nboot = 1000) {
  boot_res <- boot(data, statistic = loess_fit, R = nboot, formula = formula)
  return(boot_res)
}

# List to store bootstrapped coefficients for each variable
boot_results <- list()

# Loop through each variable and perform bootstrapping
for (variable in z_score_Age) {
  data <- biomark_df[, c("Age_V1S1", variable)]
  boot_results[[variable]] <- bootstrap_loess_coef(data = data, formula = as.formula(paste(variable, "~ Age_V1S1")))
}

# Access bootstrapped coefficients for each variable
for (variable in z_score_Age) {
  cat("Bootstrapped coefficients for", variable, ":\n")
}

# Initialize a list to store averaged predictions for each variable
averaged_predictions <- list()

# Loop through each variable to calculate averaged predictions
for (variable in z_score_Age) {
  
  # Initialize an empty vector to store predictions from each iteration
  predictions <- numeric(nrow(biomark_df))
  
  # Extract predictions from each iteration and aggregate them
  for (i in 1:1000) {
    predictions <- predictions + boot_results[[variable]]$t[i,]
  }
  
  # Calculate the average prediction across all iterations
  averaged_predictions[[variable]] <- predictions / 1000
}

averaged_predictions <- as.data.frame(averaged_predictions)

averaged_predictions$Age_V1S1  <- biomark_df$Age_V1S1


```

```{r}
# Combined bootstrap plot
gg <- ggplot(data = averaged_predictions, aes(x = Age_V1S1)) +
  geom_smooth(aes(y = Ab40_plasmaF_SimoaNP4E_BL_z_score_Age, color = "Ab40"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = Ab42_40_ratio_plasmaF_SimoaNP4E_BL_z_score_Age, color = "Ab42_40_ratio"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = Ab42_plasmaF_SimoaNP4E_BL_z_score_Age, color = "Ab42"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau181_plasmaF_Simoa_BL_z_score_Age, color = "ptau181"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau217_plasmaF_MSDLilly_BL_z_score_Age, color = "ptau217_MSDLilly"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau217_plasmaNF_SimoaJanssen_BL_z_score_Age, color = "ptau217_SimoaJanssen"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau231_plasmaF_SimoaGot_BL_z_score_Age, color = "ptau231"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ttau_plasmaF_MSDLilly_BL_z_score_Age, color = "ttau_MSDLilly"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = GFAP_plasmaF_SimoaNP4E_BL_z_score_Age, color = "GFAP"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = NFL_plasmaF_SimoaNP4E_BL_z_score_Age, color = "NFL"), 
              se = FALSE, method = "loess", linetype = 2) +
  labs(title = "Average of Bootstraps for Age reference",
       x = "Age visit 1",
       y = "Average of z-score baseline Bootstraps",
       color = "Variable") +
  geom_hline(yintercept = 2, linetype = "solid", alpha = 0.5) +  
  geom_vline(xintercept = 54.31, linetype = "dotted", alpha = 0.5, color = 'red') +
  theme_minimal()

# Convert ggplot to plotly
plotly_plot <- ggplotly(gg)

# Print the plotly plot
plotly_plot
```


```{r}
# Combined original plot
gg2 <- ggplot(data = biomark_df, aes(x = Age_V1S1)) +
  geom_smooth(aes(y = Ab40_plasmaF_SimoaNP4E_BL_z_score_Age, color = "Ab40"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = Ab42_40_ratio_plasmaF_SimoaNP4E_BL_z_score_Age, color = "Ab42_40_ratio"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = Ab42_plasmaF_SimoaNP4E_BL_z_score_Age, color = "Ab42"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau181_plasmaF_Simoa_BL_z_score_Age, color = "ptau181"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau217_plasmaF_MSDLilly_BL_z_score_Age, color = "ptau217_MSDLilly"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau217_plasmaNF_SimoaJanssen_BL_z_score_Age, color = "ptau217_SimoaJanssen"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau231_plasmaF_SimoaGot_BL_z_score_Age, color = "ptau231"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ttau_plasmaF_MSDLilly_BL_z_score_Age, color = "ttau_MSDLilly"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = GFAP_plasmaF_SimoaNP4E_BL_z_score_Age, color = "GFAP"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = NFL_plasmaF_SimoaNP4E_BL_z_score_Age, color = "NFL"), 
              se = FALSE, method = "loess", linetype = 2) +
  labs(title = "Original Age reference group  ",
       x = "Age visit 1",
       y = "z-scores Baseline",
       color = "Variable") +
  geom_hline(yintercept = 2, linetype = "solid", alpha = 0.5) +  
  geom_vline(xintercept = 54.31, linetype = "dotted", alpha = 0.5, color = 'red') +
  theme_minimal()

# Convert ggplot to plotly
plotly_plot2 <- ggplotly(gg2)

# Print the plotly plot
plotly_plot2

```

### Sex stratification

```{r}

# Sex subset

male <- biomark_df[biomark_df$Sex == 1, ]

female <- biomark_df[biomark_df$Sex == 2, ]

### Baseline

## Multiple regression

# Regression against Age 
perform_mult_regression <- function(data, dependent_variable, covariates) {
  # Create a formula for regression
  formula <- as.formula(paste(dependent_variable, "~", paste(covariates, collapse = "+")))
  
  # Fit linear regression model
  model <- lm(formula, data = data, na.action = 'na.exclude')
  
  # Store the model in a list
  result <- list(
    dependent_variable = dependent_variable,
    model = model,
    summary_result = summary(model)
  )
  
  return(result)
}

covariates <- "Age_V1S1"

# Male model

male_models <- vector("list", length = 10)

# Apply the function for each variable in difference_cols
for (i in seq_along(baseline_cols)) {
  variable <- baseline_cols[i]
  model_result <- perform_mult_regression(male, variable, covariates)
  
  # Store the model result in the list
  male_models[[i]] <- model_result
}


# Female model

female_models <- vector("list", length = 10)

# Apply the function for each variable in difference_cols
for (i in seq_along(baseline_cols)) {
  variable <- baseline_cols[i]
  model_result <- perform_mult_regression(female, variable, covariates)
  
  # Store the model result in the list
  female_models[[i]] <- model_result
}

```


### Male Reference groups

```{r}

# Quantile 10
quantile(biomark_df$amyloid_PET_CL_BL_complete, probs = 0.10, na.rm = TRUE) #-11.72535
# Quantile 90
quantile(biomark_df$ab42_40_ratio_CSFNC_BL, probs = 0.90, na.rm = TRUE) #0.09721704  

# Male reference groups

# Amyiloid group

# Create an empty list to store the results
residuals_amyloid_male <- list()

# Loop through each model in the list
for (i in seq_along(male_models)) {
  model <- male_models[[i]]$model
  
  # Extract residuals for samples with amyloid_PET_CL_BL_complete quantile
  residuals_subset <- residuals(model)[biomark_df$amyloid_PET_CL_BL_complete < -11.72535]
  
  # Calculate mean and standard deviation of residuals subset
  residuals_mean <- mean(residuals_subset, na.rm = TRUE)
  residuals_sd <- sd(residuals_subset, na.rm = TRUE)
  
  # Store the mean and sd in the results list
  residuals_amyloid_male[[i]] <- list(
    model_name = male_models[[i]]$dependent_variable,
    residuals_mean = residuals_mean,
    residuals_sd = residuals_sd
  )
  
  # Add mean and sd as new columns in biomark_df
  male[paste0("amyloid_mean_", male_models[[i]]$dependent_variable)] <- residuals_mean
  male[paste0("amyloid_sd_", male_models[[i]]$dependent_variable)] <- residuals_sd
}

# Convert the results list to a data frame
amyloid_male_df <- do.call(rbind, residuals_amyloid_male)


## CSF group

# Create an empty list to store the results
residuals_CSF_male <- list()

# Loop through each model in the list
for (i in seq_along(male_models)) {
  model <- male_models[[i]]$model
  
  # Extract residuals for samples with ab42_40_ratio_CSFNC_BL > 0.09721704
  residuals_subset <- residuals(model)[biomark_df$ab42_40_ratio_CSFNC_BL > 0.09721704]
  
  # Calculate mean and standard deviation of residuals subset
  residuals_mean <- mean(residuals_subset, na.rm = TRUE)
  residuals_sd <- sd(residuals_subset, na.rm = TRUE)
  
  # Store the mean and sd in the results list
  residuals_CSF_male[[i]] <- list(
    model_name = male_models[[i]]$dependent_variable,
    residuals_mean = residuals_mean,
    residuals_sd = residuals_sd
  )
  
  # Add mean and sd as new columns in biomark_df
  male[paste0("CSF_mean_", male_models[[i]]$dependent_variable)] <- residuals_mean
  male[paste0("CSF_sd_", male_models[[i]]$dependent_variable)] <- residuals_sd
}

# Convert the results list to a data frame
CSF_male_df <- do.call(rbind, residuals_CSF_male)



```



# Same reference groups

```{r}


# Female reference groups

## Quantile 10
quantile(biomark_df$amyloid_PET_CL_BL_complete, probs = 0.10, na.rm = TRUE)
#-11.72535
## Quantile 90
quantile(biomark_df$ab42_40_ratio_CSFNC_BL, probs = 0.90, na.rm = TRUE)
#0.09721704  

## Amyiloid group

# Create an empty list to store the results
residuals_amyloid_female <- list()

# Loop through each model in the list
for (i in seq_along(female_models)) {
  model <- female_models[[i]]$model
  
  # Extract residuals for samples with amyloid_PET_CL_BL_complete < -12.68021
  residuals_subset <- residuals(model)[biomark_df$amyloid_PET_CL_BL_complete < -11.72535]
  
  # Calculate mean and standard deviation of residuals subset
  residuals_mean <- mean(residuals_subset, na.rm = TRUE)
  residuals_sd <- sd(residuals_subset, na.rm = TRUE)
  
  # Store the mean and sd in the results list
  residuals_amyloid_female[[i]] <- list(
    model_name = female_models[[i]]$dependent_variable,
    residuals_mean = residuals_mean,
    residuals_sd = residuals_sd
  )
  
  # Add mean and sd as new columns in biomark_df
  female[paste0("amyloid_mean_", female_models[[i]]$dependent_variable)] <- residuals_mean
  female[paste0("amyloid_sd_", female_models[[i]]$dependent_variable)] <- residuals_sd
}

# Convert the results list to a data frame
amyloid_female_df <- do.call(rbind, residuals_amyloid_female)


## CSF group

# Create an empty list to store the results
residuals_CSF_female <- list()

# Loop through each model in the list
for (i in seq_along(female_models)) {
  model <- female_models[[i]]$model
  
  # Extract residuals for samples with ab42_40_ratio_CSFNC_BL > 0.09721704
  residuals_subset <- residuals(model)[biomark_df$ab42_40_ratio_CSFNC_BL > 0.09721704]
  
  # Calculate mean and standard deviation of residuals subset
  residuals_mean <- mean(residuals_subset, na.rm = TRUE)
  residuals_sd <- sd(residuals_subset, na.rm = TRUE)
  
  # Store the mean and sd in the results list
  residuals_CSF_female[[i]] <- list(
    model_name = female_models[[i]]$dependent_variable,
    residuals_mean = residuals_mean,
    residuals_sd = residuals_sd
  )
  
  # Add mean and sd as new columns in biomark_df
  female[paste0("CSF_mean_", female_models[[i]]$dependent_variable)] <- residuals_mean
  female[paste0("CSF_sd_", female_models[[i]]$dependent_variable)] <- residuals_sd
}

# Convert the results list to a data frame
CSF_female_df <- do.call(rbind, residuals_CSF_female)

```

### Z-scores for Amyloid PET reference group

```{r}
# Function to compute z-scores for a list of models
compute_z_scores_PET <- function(model_list, data) {
  # Loop through each model in the list
  for (i in seq_along(model_list)) {
    model <- model_list[[i]]$model
    variable <- model_list[[i]]$dependent_variable
    
      # Extract the residuals from the model
      residuals <- residuals(model)
      
      # Get mean and standard deviation from the corresponding columns in the data frame
      mean_col <- paste("amyloid_mean_", variable, sep = "")
      sd_col <- paste( "amyloid_sd_", variable, sep = "")
      mean_val <- data[[mean_col]][1]
      sd_val <- data[[sd_col]][1]
      
      # Scale residuals by the mean and standard deviation
      z_scores <- scale(residuals, center = mean_val, scale = sd_val)
      
      # Create a new column in the data frame for the scaled z-scores
      z_score_col <- paste(variable, "_z_score_PET", sep = "")
      
      # Update the data frame with the z_scores
      data <- data %>%
      mutate(!!z_score_col := z_scores)
    
  }
  
  return(data)
}

# Z-scores for male subset
male <- compute_z_scores_PET(male_models, male)
female <- compute_z_scores_PET(female_models, female)

### Plot of PET amyloid z-scores against proxies

# Your list of z_score variables and proxy variables
z_score_PET <- c("Ab40_plasmaF_SimoaNP4E_BL_z_score_PET", "Ab42_40_ratio_plasmaF_SimoaNP4E_BL_z_score_PET", "Ab42_plasmaF_SimoaNP4E_BL_z_score_PET", "ptau181_plasmaF_Simoa_BL_z_score_PET", "ptau217_plasmaF_MSDLilly_BL_z_score_PET", "ptau217_plasmaNF_SimoaJanssen_BL_z_score_PET", "ptau231_plasmaF_SimoaGot_BL_z_score_PET", "ttau_plasmaF_MSDLilly_BL_z_score_PET",  "GFAP_plasmaF_SimoaNP4E_BL_z_score_PET","NFL_plasmaF_SimoaNP4E_BL_z_score_PET")

# Define a color palette for z_score variables
color_palette <- rainbow(length(z_score_PET))

# Select the columns to be multiplied by -1
columns_to_multiply <- c("Ab42_40_ratio_plasmaF_SimoaNP4E_BL_z_score_PET", "Ab42_plasmaF_SimoaNP4E_BL_z_score_PET")

# Multiply the selected columns by -1
male[, columns_to_multiply] <- male[, columns_to_multiply] * -1
female[, columns_to_multiply] <- female[, columns_to_multiply] * -1


```

### Male

### Amyloid PET Centiloid BL

### Individual biomarkers plot
```{r}

## Single plots

# Create a data frame to store the response variable names
plot_data <- data.frame(z_score_var = rep(z_score_PET, each = nrow(male)),
                        amyloid_PET_CL_BL_complete = rep(male$amyloid_PET_CL_BL_complete, times = length(z_score_PET)),
                        value = as.vector(sapply(z_score_PET, function(z_var) male[[z_var]])))

### Amyloid proxy different plots

# Plot ggplot with loess smoothing for each z_score variable
facet_plot <- ggplot(plot_data, aes(x = amyloid_PET_CL_BL_complete, y = value, color = z_score_var)) +
  geom_smooth(method = "loess", span = 0.9, aes(fill = z_score_var), alpha = 0.1) +
  labs(title = " Amyloid reference group in males, Amyloid PET Centiloid BL as proxy",
       x = "amyloid_PET_CL_BL_complete",
       y = "Rate of change (z-score)") +
  scale_color_manual(values = setNames(color_palette, z_score_PET)) +
  theme_minimal() +
  facet_wrap(~ z_score_var, scales = "free_y")

# Convert ggplot to Plotly
facet_amyloid <- ggplotly(facet_plot)

# Print the Plotly plot
print(facet_amyloid)

```

### Combined biomarkers plot
```{r}
## Combined plots

# Create a data frame to store the response variable names
plot_data <- data.frame(z_score_var = rep(z_score_PET, each = nrow(male)),
                        amyloid_PET_CL_BL_complete = rep(male$amyloid_PET_CL_BL_complete, times = length(z_score_PET)),
                        value = as.vector(sapply(z_score_PET, function(z_var) male[[z_var]])))

# Plot ggplot with loess smoothing for each z_score variable
combined_plot <- ggplot(plot_data, aes(x = amyloid_PET_CL_BL_complete, y = value, color = z_score_var)) +
  geom_smooth(method = "loess", linetype = 2, span = 0.9, aes(fill = z_score_var), alpha = 0.1, se = FALSE) +
  geom_hline(yintercept = 2, linetype = "solid", alpha = 0.5) +  
  geom_vline(xintercept = 12, linetype = "dotted", alpha = 0.5, color = 'red') +
  annotate("text", x = -10, y = 2.2, label = "2 s.d.", size = 3, fontface = 'bold') +
  labs(title = "Amyloid reference group in males ",
       x = "amyloid_PET_CL_BL_complete",
       y = "Baseline z-scores") +
  scale_color_manual(values = setNames(color_palette, z_score_PET)) +
  theme_minimal()

# Convert ggplot to plotly plot
combined_amyloid <- ggplotly(combined_plot)

# Print the interactive plot
combined_amyloid

```



### Bootstrapping
```{r}

# Function to fit loess model and calculate coefficients
loess_fit <- function(formula, data, indices) {
  d <- data[indices, ]
  fit <- loess(formula, data = d)
  pred <- predict(fit, newdata = data)
  return(pred)
}

# Bootstrap function to obtain coefficients for each variable
bootstrap_loess_coef <- function(data, formula, nboot = 1000) {
  boot_res <- boot(data, statistic = loess_fit, R = nboot, formula = formula)
  return(boot_res)
}

# List to store bootstrapped coefficients for each variable
boot_results <- list()

# Loop through each variable and perform bootstrapping
for (variable in z_score_PET) {
  data <- male[, c("amyloid_PET_CL_BL_complete", variable)]
  boot_results[[variable]] <- bootstrap_loess_coef(data = data, formula = as.formula(paste(variable, "~ amyloid_PET_CL_BL_complete")))
}

# Access bootstrapped coefficients for each variable
for (variable in z_score_PET) {
  cat("Bootstrapped coefficients for", variable, ":\n")
}

# Initialize a list to store averaged predictions for each variable
averaged_predictions <- list()

# Loop through each variable to calculate averaged predictions
for (variable in z_score_PET) {
  cat("Calculating averaged predictions for", variable, ":\n")
  
  # Initialize an empty vector to store predictions from each iteration
  predictions <- numeric(nrow(male))
  
  # Extract predictions from each iteration and aggregate them
  for (i in 1:1000) {
    predictions <- predictions + boot_results[[variable]]$t[i,]
  }
  
  # Calculate the average prediction across all iterations
  averaged_predictions[[variable]] <- predictions / 1000
  
  # Print the averaged predictions for each variable
  cat("Averaged predictions for", variable, ":\n")
}

averaged_predictions <- as.data.frame(averaged_predictions)

averaged_predictions$amyloid_PET_CL_BL_complete  <- male$amyloid_PET_CL_BL_complete


```


```{r}
# Combined bootstrap plot
gg <- ggplot(data = averaged_predictions, aes(x = amyloid_PET_CL_BL_complete)) +
  geom_smooth(aes(y = Ab40_plasmaF_SimoaNP4E_BL_z_score_PET, color = "Ab40"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = Ab42_40_ratio_plasmaF_SimoaNP4E_BL_z_score_PET, color = "Ab42_40_ratio"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = Ab42_plasmaF_SimoaNP4E_BL_z_score_PET, color = "Ab42"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau181_plasmaF_Simoa_BL_z_score_PET, color = "ptau181"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau217_plasmaF_MSDLilly_BL_z_score_PET, color = "ptau217_MSDLilly"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau217_plasmaNF_SimoaJanssen_BL_z_score_PET, color = "ptau217_SimoaJanssen"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau231_plasmaF_SimoaGot_BL_z_score_PET, color = "ptau231"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ttau_plasmaF_MSDLilly_BL_z_score_PET, color = "ttau_MSDLilly"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = GFAP_plasmaF_SimoaNP4E_BL_z_score_PET, color = "GFAP"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = NFL_plasmaF_SimoaNP4E_BL_z_score_PET, color = "NFL"), 
              se = FALSE, method = "loess", linetype = 2) +
  labs(title = "Average of Bootstraps for amyloid PET in males",
       x = "amyloid_PET_CL_BL_complete",
       y = "Average of z-score baseline Bootstraps",
       color = "Variable") +
  geom_hline(yintercept = 2, linetype = "solid", alpha = 0.5) +  
  geom_vline(xintercept = 12, linetype = "dotted", alpha = 0.5, color = 'red') +
  theme_minimal()

# Convert ggplot to plotly
plotly_plot <- ggplotly(gg)

# Print the plotly plot
plotly_plot
```


```{r}
# Combined original plot
gg2 <- ggplot(data = male, aes(x = amyloid_PET_CL_BL_complete)) +
  geom_smooth(aes(y = Ab40_plasmaF_SimoaNP4E_BL_z_score_PET, color = "Ab40"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = Ab42_40_ratio_plasmaF_SimoaNP4E_BL_z_score_PET, color = "Ab42_40_ratio"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = Ab42_plasmaF_SimoaNP4E_BL_z_score_PET, color = "Ab42"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau181_plasmaF_Simoa_BL_z_score_PET, color = "ptau181"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau217_plasmaF_MSDLilly_BL_z_score_PET, color = "ptau217_MSDLilly"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau217_plasmaNF_SimoaJanssen_BL_z_score_PET, color = "ptau217_SimoaJanssen"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau231_plasmaF_SimoaGot_BL_z_score_PET, color = "ptau231"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ttau_plasmaF_MSDLilly_BL_z_score_PET, color = "ttau_MSDLilly"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = GFAP_plasmaF_SimoaNP4E_BL_z_score_PET, color = "GFAP"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = NFL_plasmaF_SimoaNP4E_BL_z_score_PET, color = "NFL"), 
              se = FALSE, method = "loess", linetype = 2) +
  labs(title = "Original Amyiloid PET reference group in males ",
       x = "amyloid_PET_CL_BL_complete",
       y = "z-scores Baseline",
       color = "Variable") +
  geom_hline(yintercept = 2, linetype = "solid", alpha = 0.5) +  
  geom_vline(xintercept = 12, linetype = "dotted", alpha = 0.5, color = 'red') +
  theme_minimal()

# Convert ggplot to plotly
plotly_plot2 <- ggplotly(gg2)

# Print the plotly plot
plotly_plot2

```




### Female 

### Amyloid PET Centiloid BL

### Individual biomarkers plot
```{r}

## Single plots

# Create a data frame to store the response variable names
plot_data <- data.frame(z_score_var = rep(z_score_PET, each = nrow(female)),
                        amyloid_PET_CL_BL_complete = rep(female$amyloid_PET_CL_BL_complete, times = length(z_score_PET)),
                        value = as.vector(sapply(z_score_PET, function(z_var) female[[z_var]])))

### Amyloid proxy different plots

# Plot ggplot with loess smoothing for each z_score variable
facet_plot <- ggplot(plot_data, aes(x = amyloid_PET_CL_BL_complete, y = value, color = z_score_var)) +
  geom_smooth(method = "loess", span = 0.9, aes(fill = z_score_var), alpha = 0.1) +
  labs(title = "Amyloid reference group in females",
       x = "amyloid_PET_CL_BL_complete",
       y = "Baseline z-scores") +
  scale_color_manual(values = setNames(color_palette, z_score_PET)) +
  theme_minimal() +
  facet_wrap(~ z_score_var, scales = "free_y")

# Convert ggplot to Plotly
facet_amyloid <- ggplotly(facet_plot)

# Print the Plotly plot
print(facet_amyloid)

```

### Combined biomarkers plot
```{r}
## Combined plots

# Create a data frame to store the response variable names
plot_data <- data.frame(z_score_var = rep(z_score_PET, each = nrow(female)),
                        amyloid_PET_CL_BL_complete = rep(female$amyloid_PET_CL_BL_complete, times = length(z_score_PET)),
                        value = as.vector(sapply(z_score_PET, function(z_var) female[[z_var]])))

# Plot ggplot with loess smoothing for each z_score variable
combined_plot <- ggplot(plot_data, aes(x = amyloid_PET_CL_BL_complete, y = value, color = z_score_var)) +
  geom_smooth(method = "loess", linetype = 2, span = 0.9, aes(fill = z_score_var), alpha = 0.1, se = FALSE) +
  geom_hline(yintercept = 2, linetype = "solid", alpha = 0.5) +  
  geom_vline(xintercept = 12, linetype = "dotted", alpha = 0.5, color = 'red') +
  annotate("text", x = -10, y = 2.2, label = "2 s.d.", size = 3, fontface = 'bold') +
  labs(title = "Amyloid reference group in females",
       x = "amyloid_PET_CL_BL_complete",
       y = "Baseline z-scores") +
  scale_color_manual(values = setNames(color_palette, z_score_PET)) +
  theme_minimal()

# Convert ggplot to plotly plot
combined_amyloid <- ggplotly(combined_plot)

# Print the interactive plot
combined_amyloid

```


### Bootstrapping
```{r}

# Function to fit loess model and calculate coefficients
loess_fit <- function(formula, data, indices) {
  d <- data[indices, ]
  fit <- loess(formula, data = d)
  pred <- predict(fit, newdata = data)
  return(pred)
}

# Bootstrap function to obtain coefficients for each variable
bootstrap_loess_coef <- function(data, formula, nboot = 1000) {
  boot_res <- boot(data, statistic = loess_fit, R = nboot, formula = formula)
  return(boot_res)
}

# List to store bootstrapped coefficients for each variable
boot_results <- list()

# Loop through each variable and perform bootstrapping
for (variable in z_score_PET) {
  data <- female[, c("amyloid_PET_CL_BL_complete", variable)]
  boot_results[[variable]] <- bootstrap_loess_coef(data = data, formula = as.formula(paste(variable, "~ amyloid_PET_CL_BL_complete")))
}

# Access bootstrapped coefficients for each variable
for (variable in z_score_PET) {
  cat("Bootstrapped coefficients for", variable, ":\n")
}

# Initialize a list to store averaged predictions for each variable
averaged_predictions <- list()

# Loop through each variable to calculate averaged predictions
for (variable in z_score_PET) {
  cat("Calculating averaged predictions for", variable, ":\n")
  
  # Initialize an empty vector to store predictions from each iteration
  predictions <- numeric(nrow(female))
  
  # Extract predictions from each iteration and aggregate them
  for (i in 1:1000) {
    predictions <- predictions + boot_results[[variable]]$t[i,]
  }
  
  # Calculate the average prediction across all iterations
  averaged_predictions[[variable]] <- predictions / 1000
  
  # Print the averaged predictions for each variable
  cat("Averaged predictions for", variable, ":\n")
}

averaged_predictions <- as.data.frame(averaged_predictions)

averaged_predictions$amyloid_PET_CL_BL_complete  <- female$amyloid_PET_CL_BL_complete



```




```{r}
# Combined bootstrap plot
gg <- ggplot(data = averaged_predictions, aes(x = amyloid_PET_CL_BL_complete)) +
  geom_smooth(aes(y = Ab40_plasmaF_SimoaNP4E_BL_z_score_PET, color = "Ab40"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = Ab42_40_ratio_plasmaF_SimoaNP4E_BL_z_score_PET, color = "Ab42_40_ratio"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = Ab42_plasmaF_SimoaNP4E_BL_z_score_PET, color = "Ab42"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau181_plasmaF_Simoa_BL_z_score_PET, color = "ptau181"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau217_plasmaF_MSDLilly_BL_z_score_PET, color = "ptau217_MSDLilly"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau217_plasmaNF_SimoaJanssen_BL_z_score_PET, color = "ptau217_SimoaJanssen"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau231_plasmaF_SimoaGot_BL_z_score_PET, color = "ptau231"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ttau_plasmaF_MSDLilly_BL_z_score_PET, color = "ttau_MSDLilly"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = GFAP_plasmaF_SimoaNP4E_BL_z_score_PET, color = "GFAP"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = NFL_plasmaF_SimoaNP4E_BL_z_score_PET, color = "NFL"), 
              se = FALSE, method = "loess", linetype = 2) +
  labs(title = "Average of Bootstraps for amyloid PET in females",
       x = "amyloid_PET_CL_BL_complete",
       y = "Average of z-score baseline Bootstraps",
       color = "Variable") +
  geom_hline(yintercept = 2, linetype = "solid", alpha = 0.5) +  
  geom_vline(xintercept = 12, linetype = "dotted", alpha = 0.5, color = 'red') +
  theme_minimal()

# Convert ggplot to plotly
plotly_plot <- ggplotly(gg)

# Print the plotly plot
plotly_plot
```


```{r}
# Combined original plot
gg2 <- ggplot(data = female, aes(x = amyloid_PET_CL_BL_complete)) +
  geom_smooth(aes(y = Ab40_plasmaF_SimoaNP4E_BL_z_score_PET, color = "Ab40"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = Ab42_40_ratio_plasmaF_SimoaNP4E_BL_z_score_PET, color = "Ab42_40_ratio"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = Ab42_plasmaF_SimoaNP4E_BL_z_score_PET, color = "Ab42"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau181_plasmaF_Simoa_BL_z_score_PET, color = "ptau181"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau217_plasmaF_MSDLilly_BL_z_score_PET, color = "ptau217_MSDLilly"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau217_plasmaNF_SimoaJanssen_BL_z_score_PET, color = "ptau217_SimoaJanssen"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau231_plasmaF_SimoaGot_BL_z_score_PET, color = "ptau231"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ttau_plasmaF_MSDLilly_BL_z_score_PET, color = "ttau_MSDLilly"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = GFAP_plasmaF_SimoaNP4E_BL_z_score_PET, color = "GFAP"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = NFL_plasmaF_SimoaNP4E_BL_z_score_PET, color = "NFL"), 
              se = FALSE, method = "loess", linetype = 2) +
  labs(title = "Original Amyiloid PET reference group in females ",
       x = "amyloid_PET_CL_BL_complete",
       y = "z-scores Baseline",
       color = "Variable") +
  geom_hline(yintercept = 2, linetype = "solid", alpha = 0.5) +  
  geom_vline(xintercept = 12, linetype = "dotted", alpha = 0.5, color = 'red') +
  theme_minimal()

# Convert ggplot to plotly
plotly_plot2 <- ggplotly(gg2)

# Print the plotly plot
plotly_plot2

```





### Compute z-scores using CSF AB 42/40 ratio reference group

```{r}
# Function to compute z-scores for a list of models
compute_z_scores_CSF <- function(model_list, data) {
  # Loop through each model in the list
  for (i in seq_along(model_list)) {
    model <- model_list[[i]]$model
    variable <- model_list[[i]]$dependent_variable
    
      # Extract the residuals from the model
      residuals <- residuals(model)
      
      # Get mean and standard deviation from the corresponding columns in the data frame
      mean_col <- paste("CSF_mean_", variable, sep = "")
      sd_col <- paste( "CSF_sd_", variable, sep = "")
      mean_val <- data[[mean_col]][1]
      sd_val <- data[[sd_col]][1]
      
      # Scale residuals by the mean and standard deviation
      z_scores <- scale(residuals, center = mean_val, scale = sd_val)
      
      # Create a new column in the data frame for the scaled z-scores
      z_score_col <- paste(variable, "_z_score_CSF", sep = "")
      
      # Update the data frame with the z_scores
      data <- data %>%
      mutate(!!z_score_col := z_scores)
    
  }
  
  return(data)
}

# Apply the function for each list of models
# Z-scores for male subset
male <- compute_z_scores_CSF(male_models, male)
female <- compute_z_scores_CSF(female_models, female)

# List of CSF z_score variables
z_score_CSF <- c("Ab40_plasmaF_SimoaNP4E_BL_z_score_CSF", "Ab42_40_ratio_plasmaF_SimoaNP4E_BL_z_score_CSF", "Ab42_plasmaF_SimoaNP4E_BL_z_score_CSF", "ptau181_plasmaF_Simoa_BL_z_score_CSF", "ptau217_plasmaF_MSDLilly_BL_z_score_CSF", "ptau217_plasmaNF_SimoaJanssen_BL_z_score_CSF", "ptau231_plasmaF_SimoaGot_BL_z_score_CSF", "ttau_plasmaF_MSDLilly_BL_z_score_CSF",  "GFAP_plasmaF_SimoaNP4E_BL_z_score_CSF","NFL_plasmaF_SimoaNP4E_BL_z_score_CSF")

# Color palette for z_score variables
color_palette <- rainbow(length(z_score_CSF))

columns_to_multiply <- c("Ab42_40_ratio_plasmaF_SimoaNP4E_BL_z_score_CSF", "Ab42_plasmaF_SimoaNP4E_BL_z_score_CSF")


male[, columns_to_multiply] <- male[, columns_to_multiply] * -1
female[, columns_to_multiply] <- female[, columns_to_multiply] * -1


```

### Male 

### CSF ratio

### Individual biomarkers plot
```{r}
# Create a data frame to store the response variable names
plot_data <- data.frame(z_score_var = rep(z_score_CSF, each = nrow(male)),
                        ab42_40_ratio_CSFNC_BL = rep(male$ab42_40_ratio_CSFNC_BL, times = length(z_score_CSF)),
                        value = as.vector(sapply(z_score_CSF, function(z_var) male[[z_var]])))

### Amyloid proxy different plots

# Plot ggplot with loess smoothing for each z_score variable
facet_plot <- ggplot(plot_data, aes(x = ab42_40_ratio_CSFNC_BL, y = value, color = z_score_var)) +
  geom_smooth(method = "loess", span = 0.9, aes(fill = z_score_var), alpha = 0.1) +
  labs(title = " CSF reference group in males, CSF AB 42/40 ratio as proxy",
       x = "ab42_40_ratio_CSFNC_BL",
       y = "Rate of change (z-score)") +
  scale_color_manual(values = setNames(color_palette, z_score_CSF)) +
  theme_minimal() +
  scale_x_continuous(trans = "reverse") +
  facet_wrap(~ z_score_var, scales = "free_y")

# Convert ggplot to interactive plot using ggplotly
facet_CSF <- ggplotly(facet_plot)

# Print the interactive plot
print(facet_CSF)


```

### Combined biomarkers plot
```{r}
### Combined plot

# Create a data frame to store the response variable names
plot_data <- data.frame(z_score_var = rep(z_score_CSF, each = nrow(male)),
                        ab42_40_ratio_CSFNC_BL = rep(male$ab42_40_ratio_CSFNC_BL, times = length(z_score_CSF)),
                        value = as.vector(sapply(z_score_CSF, function(z_var) male[[z_var]])))

# Plot ggplot with loess smoothing for each z_score variable
combined_plot <- ggplot(plot_data, aes(x = ab42_40_ratio_CSFNC_BL, y = value, color = z_score_var)) +
  geom_smooth(method = "loess", linetype = 2, span = 0.9, aes(fill = z_score_var), alpha = 0.1, se = FALSE) +
  geom_hline(yintercept = 2, linetype = "solid", alpha = 0.5) +  
  geom_vline(xintercept = 0.071, linetype = "dotted", alpha = 0.5, color = 'red') +
  annotate("text", x = 0.1, y = 2.2, label = "2 s.d.", size = 3, fontface = 'bold') +
  labs(title = "CSF reference group in males",
       x = "ab42/40 ratio CSFNC Baseline",
       y = "Baseline z-scores") +
  scale_color_manual(values = setNames(color_palette, z_score_CSF)) +
  theme_minimal() +
  scale_x_continuous(trans = "reverse")

# Convert ggplot to interactive plot using ggplotly
combined_CSF <- ggplotly(combined_plot)

# Print the interactive plot
print(combined_CSF)

```


### Bootstrapping
```{r}

# Function to fit loess model and calculate coefficients
loess_fit <- function(formula, data, indices) {
  d <- data[indices, ]
  fit <- loess(formula, data = d)
  pred <- predict(fit, newdata = data)
  return(pred)
}

# Bootstrap function to obtain coefficients for each variable
bootstrap_loess_coef <- function(data, formula, nboot = 1000) {
  boot_res <- boot(data, statistic = loess_fit, R = nboot, formula = formula)
  return(boot_res)
}

# List to store bootstrapped coefficients for each variable
boot_results <- list()

# Loop through each variable and perform bootstrapping
for (variable in z_score_CSF) {
  data <- male[, c("ab42_40_ratio_CSFNC_BL", variable)]
  boot_results[[variable]] <- bootstrap_loess_coef(data = data, formula = as.formula(paste(variable, "~ ab42_40_ratio_CSFNC_BL")))
}

# Access bootstrapped coefficients for each variable
for (variable in z_score_CSF) {
  cat("Bootstrapped coefficients for", variable, ":\n")
}

# Initialize a list to store averaged predictions for each variable
averaged_predictions <- list()

# Loop through each variable to calculate averaged predictions
for (variable in z_score_CSF) {
  cat("Calculating averaged predictions for", variable, ":\n")
  
  # Initialize an empty vector to store predictions from each iteration
  predictions <- numeric(nrow(male))
  
  # Extract predictions from each iteration and aggregate them
  for (i in 1:1000) {
    predictions <- predictions + boot_results[[variable]]$t[i,]
  }
  
  # Calculate the average prediction across all iterations
  averaged_predictions[[variable]] <- predictions / 1000
  
  # Print the averaged predictions for each variable
  cat("Averaged predictions for", variable, ":\n")
}

averaged_predictions <- as.data.frame(averaged_predictions)

averaged_predictions$ab42_40_ratio_CSFNC_BL  <- male$ab42_40_ratio_CSFNC_BL


```



```{r}
# Combined bootstrap plot
gg <- ggplot(data = averaged_predictions, aes(x = ab42_40_ratio_CSFNC_BL)) +
  geom_smooth(aes(y = Ab40_plasmaF_SimoaNP4E_BL_z_score_CSF, color = "Ab40"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = Ab42_40_ratio_plasmaF_SimoaNP4E_BL_z_score_CSF, color = "Ab42_40_ratio"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = Ab42_plasmaF_SimoaNP4E_BL_z_score_CSF, color = "Ab42"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau181_plasmaF_Simoa_BL_z_score_CSF, color = "ptau181"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau217_plasmaF_MSDLilly_BL_z_score_CSF, color = "ptau217_MSDLilly"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau217_plasmaNF_SimoaJanssen_BL_z_score_CSF, color = "ptau217_SimoaJanssen"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau231_plasmaF_SimoaGot_BL_z_score_CSF, color = "ptau231"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ttau_plasmaF_MSDLilly_BL_z_score_CSF, color = "ttau_MSDLilly"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = GFAP_plasmaF_SimoaNP4E_BL_z_score_CSF, color = "GFAP"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = NFL_plasmaF_SimoaNP4E_BL_z_score_CSF, color = "NFL"), 
              se = FALSE, method = "loess", linetype = 2) +
  labs(title = "Average of Bootstraps for CSF reference group in males",
       x = "ab42/40 ratio CSFNC Baseline",
       y = "Average of z-score baseline bootstraps",
       color = "Variable") +
  geom_hline(yintercept = 2, linetype = "solid", alpha = 0.5) +  
  geom_vline(xintercept = 0.071, linetype = "dotted", alpha = 0.5, color = 'red') +
  scale_x_continuous(trans = "reverse") +
  theme_minimal()

# Convert ggplot to plotly
plotly_plot <- ggplotly(gg)

# Print the plotly plot
plotly_plot
```


```{r}
# Combined original plot
gg2 <- ggplot(data = male, aes(x = ab42_40_ratio_CSFNC_BL)) +
  geom_smooth(aes(y = Ab40_plasmaF_SimoaNP4E_BL_z_score_CSF, color = "Ab40"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = Ab42_40_ratio_plasmaF_SimoaNP4E_BL_z_score_CSF, color = "Ab42_40_ratio"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = Ab42_plasmaF_SimoaNP4E_BL_z_score_CSF, color = "Ab42"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau181_plasmaF_Simoa_BL_z_score_CSF, color = "ptau181"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau217_plasmaF_MSDLilly_BL_z_score_CSF, color = "ptau217_MSDLilly"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau217_plasmaNF_SimoaJanssen_BL_z_score_CSF, color = "ptau217_SimoaJanssen"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau231_plasmaF_SimoaGot_BL_z_score_CSF, color = "ptau231"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ttau_plasmaF_MSDLilly_BL_z_score_CSF, color = "ttau_MSDLilly"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = GFAP_plasmaF_SimoaNP4E_BL_z_score_CSF, color = "GFAP"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = NFL_plasmaF_SimoaNP4E_BL_z_score_CSF, color = "NFL"), 
              se = FALSE, method = "loess", linetype = 2) +
  labs(title = "Original CSF reference group in males ",
       x = "ab42/40 ratio CSFNC Baseline",
       y = "z-scores Baseline",
       color = "Variable") +
  geom_hline(yintercept = 2, linetype = "solid", alpha = 0.5) +  
  geom_vline(xintercept = 0.071, linetype = "dotted", alpha = 0.5, color = 'red') +
  scale_x_continuous(trans = "reverse") +
  theme_minimal()

# Convert ggplot to plotly
plotly_plot2 <- ggplotly(gg2)

# Print the plotly plot
plotly_plot2

```


### Female

### CSF ratio

### Individual biomarkers plot
```{r}
# Create a data frame to store the response variable names
plot_data <- data.frame(z_score_var = rep(z_score_CSF, each = nrow(female)),
                        ab42_40_ratio_CSFNC_BL = rep(female$ab42_40_ratio_CSFNC_BL, times = length(z_score_CSF)),
                        value = as.vector(sapply(z_score_CSF, function(z_var) female[[z_var]])))


# Plot ggplot with loess smoothing for each z_score variable
facet_plot <- ggplot(plot_data, aes(x = ab42_40_ratio_CSFNC_BL, y = value, color = z_score_var)) +
  geom_smooth(method = "loess", span = 0.9, aes(fill = z_score_var), alpha = 0.1) +
  labs(title = "CSF AB 42/40 reference group in females, CSF AB 42/40 ratio as proxy",
       x = "ab42/40 ratio CSFNC BL",
       y = "Baseline Levels") +
  scale_color_manual(values = setNames(color_palette, z_score_CSF)) +
  theme_minimal() +
  scale_x_continuous(trans = "reverse") +
  facet_wrap(~ z_score_var, scales = "free_y")

# Convert ggplot to interactive plot using ggplotly
facet_CSF <- ggplotly(facet_plot)

# Print the interactive plot
print(facet_CSF)


```

### Combined biomarkers plot
```{r}
### Combined plot

# Create a data frame to store the response variable names
plot_data <- data.frame(z_score_var = rep(z_score_CSF, each = nrow(female)),
                        ab42_40_ratio_CSFNC_BL = rep(female$ab42_40_ratio_CSFNC_BL, times = length(z_score_CSF)),
                        value = as.vector(sapply(z_score_CSF, function(z_var) female[[z_var]])))

# Plot ggplot with loess smoothing for each z_score variable
combined_plot <- ggplot(plot_data, aes(x = ab42_40_ratio_CSFNC_BL, y = value, color = z_score_var)) +
  geom_smooth(method = "loess", linetype = 2, span = 0.9, aes(fill = z_score_var), alpha = 0.1, se = FALSE) +
  geom_hline(yintercept = 2, linetype = "solid", alpha = 0.5) +  
  geom_vline(xintercept = 0.071, linetype = "dotted", alpha = 0.5, color = 'red') +
  annotate("text", x = 0.1, y = 2.2, label = "2 s.d.", size = 3, fontface = 'bold') +
  labs(title = "CSF reference group in females",
       x = "ab42/40 ratio CSFNC Baseline",
       y = "Baseline z-scores") +
  scale_color_manual(values = setNames(color_palette, z_score_CSF)) +
  theme_minimal() +
  scale_x_continuous(trans = "reverse")

# Convert ggplot to interactive plot using ggplotly
combined_CSF <- ggplotly(combined_plot)

# Print the interactive plot
print(combined_CSF)

```

### Bootstrapping
```{r}

# Function to fit loess model and calculate coefficients
loess_fit <- function(formula, data, indices) {
  d <- data[indices, ]
  fit <- loess(formula, data = d)
  pred <- predict(fit, newdata = data)
  return(pred)
}

# Bootstrap function to obtain coefficients for each variable
bootstrap_loess_coef <- function(data, formula, nboot = 1000) {
  boot_res <- boot(data, statistic = loess_fit, R = nboot, formula = formula)
  return(boot_res)
}

# List to store bootstrapped coefficients for each variable
boot_results <- list()

# Loop through each variable and perform bootstrapping
for (variable in z_score_CSF) {
  data <- female[, c("ab42_40_ratio_CSFNC_BL", variable)]
  boot_results[[variable]] <- bootstrap_loess_coef(data = data, formula = as.formula(paste(variable, "~ ab42_40_ratio_CSFNC_BL")))
}

# Access bootstrapped coefficients for each variable
for (variable in z_score_CSF) {
  cat("Bootstrapped coefficients for", variable, ":\n")
}

# Initialize a list to store averaged predictions for each variable
averaged_predictions <- list()

# Loop through each variable to calculate averaged predictions
for (variable in z_score_CSF) {
  cat("Calculating averaged predictions for", variable, ":\n")
  
  # Initialize an empty vector to store predictions from each iteration
  predictions <- numeric(nrow(female))
  
  # Extract predictions from each iteration and aggregate them
  for (i in 1:1000) {
    predictions <- predictions + boot_results[[variable]]$t[i,]
  }
  
  # Calculate the average prediction across all iterations
  averaged_predictions[[variable]] <- predictions / 1000
  
  # Print the averaged predictions for each variable
  cat("Averaged predictions for", variable, ":\n")
}

averaged_predictions <- as.data.frame(averaged_predictions)

averaged_predictions$ab42_40_ratio_CSFNC_BL  <- female$ab42_40_ratio_CSFNC_BL

```

```{r}
# Combined bootstrap plot
gg <- ggplot(data = averaged_predictions, aes(x = ab42_40_ratio_CSFNC_BL)) +
  geom_smooth(aes(y = Ab40_plasmaF_SimoaNP4E_BL_z_score_CSF, color = "Ab40"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = Ab42_40_ratio_plasmaF_SimoaNP4E_BL_z_score_CSF, color = "Ab42_40_ratio"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = Ab42_plasmaF_SimoaNP4E_BL_z_score_CSF, color = "Ab42"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau181_plasmaF_Simoa_BL_z_score_CSF, color = "ptau181"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau217_plasmaF_MSDLilly_BL_z_score_CSF, color = "ptau217_MSDLilly"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau217_plasmaNF_SimoaJanssen_BL_z_score_CSF, color = "ptau217_SimoaJanssen"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau231_plasmaF_SimoaGot_BL_z_score_CSF, color = "ptau231"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ttau_plasmaF_MSDLilly_BL_z_score_CSF, color = "ttau_MSDLilly"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = GFAP_plasmaF_SimoaNP4E_BL_z_score_CSF, color = "GFAP"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = NFL_plasmaF_SimoaNP4E_BL_z_score_CSF, color = "NFL"), 
              se = FALSE, method = "loess", linetype = 2) +
  labs(title = "Average of Bootstraps for CSF reference group in females",
       x = "ab42/40 ratio CSFNC Baseline",
       y = "Average of z-score baseline bootstraps",
       color = "Variable") +
  geom_hline(yintercept = 2, linetype = "solid", alpha = 0.5) +  
  geom_vline(xintercept = 0.071, linetype = "dotted", alpha = 0.5, color = 'red') +
  scale_x_continuous(trans = "reverse") +
  theme_minimal()

# Convert ggplot to plotly
plotly_plot <- ggplotly(gg)

# Print the plotly plot
plotly_plot
```


```{r}
# Combined original plot
gg2 <- ggplot(data = female, aes(x = ab42_40_ratio_CSFNC_BL)) +
  geom_smooth(aes(y = Ab40_plasmaF_SimoaNP4E_BL_z_score_CSF, color = "Ab40"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = Ab42_40_ratio_plasmaF_SimoaNP4E_BL_z_score_CSF, color = "Ab42_40_ratio"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = Ab42_plasmaF_SimoaNP4E_BL_z_score_CSF, color = "Ab42"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau181_plasmaF_Simoa_BL_z_score_CSF, color = "ptau181"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau217_plasmaF_MSDLilly_BL_z_score_CSF, color = "ptau217_MSDLilly"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau217_plasmaNF_SimoaJanssen_BL_z_score_CSF, color = "ptau217_SimoaJanssen"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau231_plasmaF_SimoaGot_BL_z_score_CSF, color = "ptau231"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ttau_plasmaF_MSDLilly_BL_z_score_CSF, color = "ttau_MSDLilly"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = GFAP_plasmaF_SimoaNP4E_BL_z_score_CSF, color = "GFAP"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = NFL_plasmaF_SimoaNP4E_BL_z_score_CSF, color = "NFL"), 
              se = FALSE, method = "loess", linetype = 2) +
  labs(title = "Original CSF reference group in females ",
       x = "ab42/40 ratio CSFNC Baseline",
       y = "z-scores Baseline",
       color = "Variable") +
  geom_hline(yintercept = 2, linetype = "solid", alpha = 0.5) +  
  geom_vline(xintercept = 0.071, linetype = "dotted", alpha = 0.5, color = 'red') +
  scale_x_continuous(trans = "reverse") +
  theme_minimal()

# Convert ggplot to plotly
plotly_plot2 <- ggplotly(gg2)

# Print the plotly plot
plotly_plot2

```


### Sex stratification and Age as proxy

```{r}

male <- biomark_df[biomark_df$Sex == 1, ]

female <- biomark_df[biomark_df$Sex == 2, ]


```

### Male 
```{r}
# Quantile 10
quantile(biomark_df$Age_V1S1, probs = 0.10, na.rm = TRUE) # 54.31 

male_age <- male %>%
  filter(Age_V1S1 < 54.31 ) %>%
  select(one_of(baseline_cols))

for (col_name in baseline_cols) {
  # Calculate mean and standard deviation
  mean_value <- mean(male_age[[col_name]], na.rm = TRUE)
  sd_value <- sd(male_age[[col_name]], na.rm = TRUE)
  
  # Create new variables for mean and standard deviation
  new_mean_col <- paste0(col_name, "_mean")
  new_sd_col <- paste0(col_name, "_sd")
  
  # Add mean and standard deviation as new columns to the male dataframe
  male[[new_mean_col]] <- mean_value
  male[[new_sd_col]] <- sd_value
}


# Create a function to calculate z-scores for each variable
z_scores_AgeSex_male <- function(dataframe, baseline_cols) {
  for (col_name in baseline_cols) {
    # Extract corresponding mean and sd column names
    mean_col <- paste0(col_name, "_mean")
    sd_col <- paste0(col_name, "_sd")
    
    # Calculate z-scores
    z_score_col <- paste0(col_name, "_z_score")
    dataframe[[z_score_col]] <- (dataframe[[col_name]] - dataframe[[mean_col]]) / dataframe[[sd_col]]
    }
  
  # Return the dataframe with z-scores added
  return(dataframe)
}

# Call the function to calculate z-scores for each variable in baseline_cols
male <- z_scores_AgeSex_male(male, baseline_cols)


```


# Female

```{r}

# Quantile 10
quantile(biomark_df$Age_V1S1, probs = 0.10, na.rm = TRUE) # 54.31

female_age <- female %>%
  filter(Age_V1S1 < 54.31) %>%
  select(one_of(baseline_cols))

for (col_name in baseline_cols) {
  # Calculate mean and standard deviation
  mean_value <- mean(female_age[[col_name]], na.rm = TRUE)
  sd_value <- sd(female_age[[col_name]], na.rm = TRUE)
  
  # Create new variables for mean and standard deviation
  new_mean_col <- paste0(col_name, "_mean")
  new_sd_col <- paste0(col_name, "_sd")
  
  # Add mean and standard deviation as new columns to the female dataframe
  female[[new_mean_col]] <- mean_value
  female[[new_sd_col]] <- sd_value
}

# Create a function to calculate z-scores for each variable
z_scores_AgeSex_female <- function(dataframe, baseline_cols) {
  for (col_name in baseline_cols) {
    # Extract corresponding mean and sd column names
    mean_col <- paste0(col_name, "_mean")
    sd_col <- paste0(col_name, "_sd")
    
    # Calculate z-scores
    z_score_col <- paste0(col_name, "_z_score")
    dataframe[[z_score_col]] <- (dataframe[[col_name]] - dataframe[[mean_col]]) / dataframe[[sd_col]]
  }
  
  # Return the dataframe with z-scores added
  return(dataframe)
}

# Call the function to calculate z-scores for each variable in baseline_cols for the female dataframe
female <- z_scores_AgeSex_female(female, baseline_cols)

```

```{r}

# Your list of z_score variables and proxy variables
# Define z_score variables with the new naming convention
z_score_Age_Sex<- c("Ab40_plasmaF_SimoaNP4E_BL_z_score", 
                          "Ab42_40_ratio_plasmaF_SimoaNP4E_BL_z_score", 
                          "Ab42_plasmaF_SimoaNP4E_BL_z_score", 
                          "ptau181_plasmaF_Simoa_BL_z_score", 
                          "ptau217_plasmaF_MSDLilly_BL_z_score", 
                          "ptau217_plasmaNF_SimoaJanssen_BL_z_score", 
                          "ptau231_plasmaF_SimoaGot_BL_z_score", 
                          "ttau_plasmaF_MSDLilly_BL_z_score",  
                          "GFAP_plasmaF_SimoaNP4E_BL_z_score", 
                          "NFL_plasmaF_SimoaNP4E_BL_z_score")

# Define a color palette for z_score variables
color_palette <- rainbow(length(z_score_Age_Sex))

columns_to_multiply <- c("Ab42_40_ratio_plasmaF_SimoaNP4E_BL_z_score", "Ab42_plasmaF_SimoaNP4E_BL_z_score")

male[, columns_to_multiply] <- male[, columns_to_multiply] * -1
female[, columns_to_multiply] <- female[, columns_to_multiply] * -1



```



### Male Combined plots

```{r}

# Create a data frame to store the response variable names
plot_data <- data.frame(z_score_var = rep(z_score_Age_Sex, each = nrow(male)),
                        Age_V1S1 = rep(male$Age_V1S1, times = length(z_score_Age_Sex)),
                        value = as.vector(sapply(z_score_Age_Sex, function(z_var) male[[z_var]])))

# Plot ggplot with loess smoothing for each z_score variable
combined_plot <- ggplot(plot_data, aes(x = Age_V1S1, y = value, color = z_score_var)) +
  geom_smooth(method = "loess", linetype = 2, span = 0.9, aes(fill = z_score_var), alpha = 0.1, se = FALSE) +
  geom_hline(yintercept = 2, linetype = "solid", alpha = 0.5) +  
  geom_vline(xintercept = 55.53, linetype = "dotted", alpha = 0.5, color = 'red') +
  annotate("text", x = 0.1, y = 2.2, label = "2 s.d.", size = 3, fontface = 'bold') +
 labs(title = "Age reference group in males",
       x = "Age V1S1",
       y = "Baseline z-scores") +
  scale_color_manual(values = setNames(color_palette, z_score_Age_Sex)) +
  theme_minimal() +
  xlim(49, 75) # Setting x-axis limits

# Convert ggplot to plotly plot
combined_amyloid_age <- ggplotly(combined_plot)

# Print the interactive plot
combined_amyloid_age


```

### Bootstrapping
```{r}

# Function to fit loess model and calculate coefficients
loess_fit <- function(formula, data, indices) {
  d <- data[indices, ]
  fit <- loess(formula, data = d)
  pred <- predict(fit, newdata = data)
  return(pred)
}

# Bootstrap function to obtain coefficients for each variable
bootstrap_loess_coef <- function(data, formula, nboot = 1000) {
  boot_res <- boot(data, statistic = loess_fit, R = nboot, formula = formula)
  return(boot_res)
}

# List to store bootstrapped coefficients for each variable
boot_results <- list()

# Loop through each variable and perform bootstrapping
for (variable in z_score_Age_Sex) {
  data <- male[, c("Age_V1S1", variable)]
  boot_results[[variable]] <- bootstrap_loess_coef(data = data, formula = as.formula(paste(variable, "~ Age_V1S1")))
}

# Access bootstrapped coefficients for each variable
for (variable in z_score_Age_Sex) {
  cat("Bootstrapped coefficients for", variable, ":\n")
}

# Initialize a list to store averaged predictions for each variable
averaged_predictions <- list()

# Loop through each variable to calculate averaged predictions
for (variable in z_score_Age_Sex) {
  cat("Calculating averaged predictions for", variable, ":\n")
  
  # Initialize an empty vector to store predictions from each iteration
  predictions <- numeric(nrow(male))
  
  # Extract predictions from each iteration and aggregate them
  for (i in 1:1000) {
    predictions <- predictions + boot_results[[variable]]$t[i,]
  }
  
  # Calculate the average prediction across all iterations
  averaged_predictions[[variable]] <- predictions / 1000
  
  # Print the averaged predictions for each variable
  cat("Averaged predictions for", variable, ":\n")
}

averaged_predictions <- as.data.frame(averaged_predictions)

averaged_predictions$Age_V1S1  <- male$Age_V1S1



```

```{r}
# Combined bootstrap plot
gg <- ggplot(data = averaged_predictions, aes(x = Age_V1S1)) +
  geom_smooth(aes(y = Ab40_plasmaF_SimoaNP4E_BL_z_score, color = "Ab40"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = Ab42_40_ratio_plasmaF_SimoaNP4E_BL_z_score, color = "Ab42_40_ratio"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = Ab42_plasmaF_SimoaNP4E_BL_z_score, color = "Ab42"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau181_plasmaF_Simoa_BL_z_score, color = "ptau181"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau217_plasmaF_MSDLilly_BL_z_score, color = "ptau217_MSDLilly"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau217_plasmaNF_SimoaJanssen_BL_z_score, color = "ptau217_SimoaJanssen"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau231_plasmaF_SimoaGot_BL_z_score, color = "ptau231"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ttau_plasmaF_MSDLilly_BL_z_score, color = "ttau_MSDLilly"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = GFAP_plasmaF_SimoaNP4E_BL_z_score, color = "GFAP"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = NFL_plasmaF_SimoaNP4E_BL_z_score, color = "NFL"), 
              se = FALSE, method = "loess", linetype = 2) +
  labs(title = "Average of Bootstraps for Age reference in males",
       x = "Age_V1S1",
       y = "Average of z-score baseline bootstraps",
       color = "Variable") +
  geom_hline(yintercept = 2, linetype = "solid", alpha = 0.5) +  
  geom_vline(xintercept = 54.31, linetype = "dotted", alpha = 0.5, color = 'red') +
  theme_minimal()

# Convert ggplot to plotly
plotly_plot <- ggplotly(gg)

# Print the plotly plot
plotly_plot
```


```{r}
# Combined original plot
gg2 <- ggplot(data = male, aes(x = Age_V1S1)) +
   geom_smooth(aes(y = Ab40_plasmaF_SimoaNP4E_BL_z_score, color = "Ab40"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = Ab42_40_ratio_plasmaF_SimoaNP4E_BL_z_score, color = "Ab42_40_ratio"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = Ab42_plasmaF_SimoaNP4E_BL_z_score, color = "Ab42"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau181_plasmaF_Simoa_BL_z_score, color = "ptau181"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau217_plasmaF_MSDLilly_BL_z_score, color = "ptau217_MSDLilly"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau217_plasmaNF_SimoaJanssen_BL_z_score, color = "ptau217_SimoaJanssen"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau231_plasmaF_SimoaGot_BL_z_score, color = "ptau231"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ttau_plasmaF_MSDLilly_BL_z_score, color = "ttau_MSDLilly"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = GFAP_plasmaF_SimoaNP4E_BL_z_score, color = "GFAP"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = NFL_plasmaF_SimoaNP4E_BL_z_score, color = "NFL"), 
              se = FALSE, method = "loess", linetype = 2) +
  labs(title = "Original age reference group in males ",
       x = "Age_V1S1",
       y = "z-scores Baseline",
       color = "Variable") +
  geom_hline(yintercept = 2, linetype = "solid", alpha = 0.5) +  
  geom_vline(xintercept = 54.31, linetype = "dotted", alpha = 0.5, color = 'red') +
  theme_minimal()

# Convert ggplot to plotly
plotly_plot2 <- ggplotly(gg2)

# Print the plotly plot
plotly_plot2

```

## Female combined plots

```{r}


# Create a data frame to store the response variable names
plot_data <- data.frame(z_score_var = rep(z_score_Age_Sex, each = nrow(female)),
                        Age_V1S1 = rep(female$Age_V1S1, times = length(z_score_Age_Sex)),
                        value = as.vector(sapply(z_score_Age_Sex, function(z_var) female[[z_var]])))

# Plot ggplot with loess smoothing for each z_score variable
combined_plot <- ggplot(plot_data, aes(x = Age_V1S1, y = value, color = z_score_var)) +
  geom_smooth(method = "loess", linetype = 2, span = 0.9, aes(fill = z_score_var), alpha = 0.1, se = FALSE) +
  geom_hline(yintercept = 2, linetype = "solid", alpha = 0.5) +  
  geom_vline(xintercept = 54.31, linetype = "dotted", alpha = 0.5, color = 'red') +
  annotate("text", x = 0.1, y = 2.2, label = "2 s.d.", size = 3, fontface = 'bold') +
  labs(title = "Age reference group in females",
       x = "Age V1S1",
       y = "Baseline z-scores") +
  scale_color_manual(values = setNames(color_palette, z_score_Age_Sex)) +
  theme_minimal() +
  xlim(49, 75)

# Convert ggplot to plotly plot
combined_amyloid_age <- ggplotly(combined_plot)

# Print the interactive plot
combined_amyloid_age

```

### Bootstrapping
```{r}

# Function to fit loess model and calculate coefficients
loess_fit <- function(formula, data, indices) {
  d <- data[indices, ]
  fit <- loess(formula, data = d)
  pred <- predict(fit, newdata = data)
  return(pred)
}

# Bootstrap function to obtain coefficients for each variable
bootstrap_loess_coef <- function(data, formula, nboot = 1000) {
  boot_res <- boot(data, statistic = loess_fit, R = nboot, formula = formula)
  return(boot_res)
}

# List to store bootstrapped coefficients for each variable
boot_results <- list()

# Loop through each variable and perform bootstrapping
for (variable in z_score_Age_Sex) {
  data <- female[, c("Age_V1S1", variable)]
  boot_results[[variable]] <- bootstrap_loess_coef(data = data, formula = as.formula(paste(variable, "~ Age_V1S1")))
}

# Access bootstrapped coefficients for each variable
for (variable in z_score_Age_Sex) {
  cat("Bootstrapped coefficients for", variable, ":\n")
}

# Initialize a list to store averaged predictions for each variable
averaged_predictions <- list()

# Loop through each variable to calculate averaged predictions
for (variable in z_score_Age_Sex) {
  cat("Calculating averaged predictions for", variable, ":\n")
  
  # Initialize an empty vector to store predictions from each iteration
  predictions <- numeric(nrow(female))
  
  # Extract predictions from each iteration and aggregate them
  for (i in 1:1000) {
    predictions <- predictions + boot_results[[variable]]$t[i,]
  }
  
  # Calculate the average prediction across all iterations
  averaged_predictions[[variable]] <- predictions / 1000
  
  # Print the averaged predictions for each variable
  cat("Averaged predictions for", variable, ":\n")
}

averaged_predictions <- as.data.frame(averaged_predictions)

averaged_predictions$Age_V1S1  <- female$Age_V1S1


```



```{r}
# Combined bootstrap plot
gg <- ggplot(data = averaged_predictions, aes(x = Age_V1S1)) +
  geom_smooth(aes(y = Ab40_plasmaF_SimoaNP4E_BL_z_score, color = "Ab40"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = Ab42_40_ratio_plasmaF_SimoaNP4E_BL_z_score, color = "Ab42_40_ratio"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = Ab42_plasmaF_SimoaNP4E_BL_z_score, color = "Ab42"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau181_plasmaF_Simoa_BL_z_score, color = "ptau181"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau217_plasmaF_MSDLilly_BL_z_score, color = "ptau217_MSDLilly"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau217_plasmaNF_SimoaJanssen_BL_z_score, color = "ptau217_SimoaJanssen"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau231_plasmaF_SimoaGot_BL_z_score, color = "ptau231"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ttau_plasmaF_MSDLilly_BL_z_score, color = "ttau_MSDLilly"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = GFAP_plasmaF_SimoaNP4E_BL_z_score, color = "GFAP"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = NFL_plasmaF_SimoaNP4E_BL_z_score, color = "NFL"), 
              se = FALSE, method = "loess", linetype = 2) +
  labs(title = "Average of Bootstraps for Age reference group in females",
       x = "Age_V1S1",
       y = "Average of z-score baseline bootstraps",
       color = "Variable") +
  geom_hline(yintercept = 2, linetype = "solid", alpha = 0.5) +  
  geom_vline(xintercept = 54.31, linetype = "dotted", alpha = 0.5, color = 'red') +
  theme_minimal()

# Convert ggplot to plotly
plotly_plot <- ggplotly(gg)

# Print the plotly plot
plotly_plot
```


```{r}
# Combined original plot
gg2 <- ggplot(data = female, aes(x = Age_V1S1)) +
   geom_smooth(aes(y = Ab40_plasmaF_SimoaNP4E_BL_z_score, color = "Ab40"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = Ab42_40_ratio_plasmaF_SimoaNP4E_BL_z_score, color = "Ab42_40_ratio"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = Ab42_plasmaF_SimoaNP4E_BL_z_score, color = "Ab42"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau181_plasmaF_Simoa_BL_z_score, color = "ptau181"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau217_plasmaF_MSDLilly_BL_z_score, color = "ptau217_MSDLilly"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau217_plasmaNF_SimoaJanssen_BL_z_score, color = "ptau217_SimoaJanssen"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau231_plasmaF_SimoaGot_BL_z_score, color = "ptau231"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ttau_plasmaF_MSDLilly_BL_z_score, color = "ttau_MSDLilly"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = GFAP_plasmaF_SimoaNP4E_BL_z_score, color = "GFAP"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = NFL_plasmaF_SimoaNP4E_BL_z_score, color = "NFL"), 
              se = FALSE, method = "loess", linetype = 2) +
  labs(title = "Original Age reference group in females  ",
       x = "Age_V1S1",
       y = "z-scores Baseline",
       color = "Variable") +
  geom_hline(yintercept = 2, linetype = "solid", alpha = 0.5) +  
  geom_vline(xintercept = 55.53, linetype = "dotted", alpha = 0.5, color = 'red') +
  theme_minimal()

# Convert ggplot to plotly
plotly_plot2 <- ggplotly(gg2)

# Print the plotly plot
plotly_plot2

```


### APOE Carriership


```{r}
# APOE_binary subset
carrier <- biomark_df[biomark_df$APOE_binary == 1, ]
non_carrier <- biomark_df[biomark_df$APOE_binary == 0, ]

# Baseline

# Multiple regression

# Function for multiple regression
perform_mult_regression <- function(data, dependent_variable, covariates) {
  formula <- as.formula(paste(dependent_variable, "~", paste(covariates, collapse = "+")))
  model <- lm(formula, data = data, na.action = 'na.exclude')
  result <- list(
    dependent_variable = dependent_variable,
    model = model,
    summary_result = summary(model)
  )
  return(result)
}

covariates <- c("Age_V1S1", "Sex")

# Carrier model
carrier_models <- vector("list", length = 10)

for (i in seq_along(baseline_cols)) {
  variable <- baseline_cols[i]
  model_result <- perform_mult_regression(carrier, variable, covariates)
  carrier_models[[i]] <- model_result
}

# Non-carrier model
non_carrier_models <- vector("list", length = 10)

for (i in seq_along(baseline_cols)) {
  variable <- baseline_cols[i]
  model_result <- perform_mult_regression(non_carrier, variable, covariates)
  non_carrier_models[[i]] <- model_result
}

```


### Reference groups

```{r}
# Reference groups

## Carrier quantiles
quantile(biomark_df$amyloid_PET_CL_BL_complete, probs = 0.10, na.rm = TRUE) # -11.72535 
quantile(biomark_df$ab42_40_ratio_CSFNC_BL, probs = 0.90, na.rm = TRUE) # 0.09721704


## Non-carrier quantiles
quantile(biomark_df$amyloid_PET_CL_BL_complete, probs = 0.10, na.rm = TRUE) # -11.72535 
quantile(biomark_df$ab42_40_ratio_CSFNC_BL, probs = 0.90, na.rm = TRUE) # 0.09721704

# Carrier reference groups

# Amyloid group
residuals_amyloid_carrier <- list()
for (i in seq_along(carrier_models)) {
  model <- carrier_models[[i]]$model
  residuals_subset <- residuals(model)[biomark_df$amyloid_PET_CL_BL_complete < -11.72535]
  residuals_mean <- mean(residuals_subset, na.rm = TRUE)
  residuals_sd <- sd(residuals_subset, na.rm = TRUE)
  residuals_amyloid_carrier[[i]] <- list(
    model_name = carrier_models[[i]]$dependent_variable,
    residuals_mean = residuals_mean,
    residuals_sd = residuals_sd
  )
  carrier[paste0("amyloid_mean_", carrier_models[[i]]$dependent_variable)] <- residuals_mean
  carrier[paste0("amyloid_sd_", carrier_models[[i]]$dependent_variable)] <- residuals_sd
}
amyloid_carrier_df <- do.call(rbind, residuals_amyloid_carrier)

# CSF group
residuals_CSF_carrier <- list()
for (i in seq_along(carrier_models)) {
  model <- carrier_models[[i]]$model
  residuals_subset <- residuals(model)[biomark_df$ab42_40_ratio_CSFNC_BL > 0.09721704]
  residuals_mean <- mean(residuals_subset, na.rm = TRUE)
  residuals_sd <- sd(residuals_subset, na.rm = TRUE)
  residuals_CSF_carrier[[i]] <- list(
    model_name = carrier_models[[i]]$dependent_variable,
    residuals_mean = residuals_mean,
    residuals_sd = residuals_sd
  )
  carrier[paste0("CSF_mean_", carrier_models[[i]]$dependent_variable)] <- residuals_mean
  carrier[paste0("CSF_sd_", carrier_models[[i]]$dependent_variable)] <- residuals_sd
}
CSF_carrier_df <- do.call(rbind, residuals_CSF_carrier)


# Non-carrier reference groups

# Amyloid group
residuals_amyloid_non_carrier <- list()
for (i in seq_along(non_carrier_models)) {
  model <- non_carrier_models[[i]]$model
  residuals_subset <- residuals(model)[biomark_df$amyloid_PET_CL_BL_complete < -11.72535]
  residuals_mean <- mean(residuals_subset, na.rm = TRUE)
  residuals_sd <- sd(residuals_subset, na.rm = TRUE)
  residuals_amyloid_non_carrier[[i]] <- list(
    model_name = non_carrier_models[[i]]$dependent_variable,
    residuals_mean = residuals_mean,
    residuals_sd = residuals_sd
  )
  non_carrier[paste0("amyloid_mean_", non_carrier_models[[i]]$dependent_variable)] <- residuals_mean
  non_carrier[paste0("amyloid_sd_", non_carrier_models[[i]]$dependent_variable)] <- residuals_sd
}
amyloid_non_carrier_df <- do.call(rbind, residuals_amyloid_non_carrier)

# CSF group
residuals_CSF_non_carrier <- list()
for (i in seq_along(non_carrier_models)) {
  model <- non_carrier_models[[i]]$model
  residuals_subset <- residuals(model)[biomark_df$ab42_40_ratio_CSFNC_BL > 0.09721704]
  residuals_mean <- mean(residuals_subset, na.rm = TRUE)
  residuals_sd <- sd(residuals_subset, na.rm = TRUE)
  residuals_CSF_non_carrier[[i]] <- list(
    model_name = non_carrier_models[[i]]$dependent_variable,
    residuals_mean = residuals_mean,
    residuals_sd = residuals_sd
  )
  non_carrier[paste0("CSF_mean_", non_carrier_models[[i]]$dependent_variable)] <- residuals_mean
  non_carrier[paste0("CSF_sd_", non_carrier_models[[i]]$dependent_variable)] <- residuals_sd
}
CSF_non_carrier_df <- do.call(rbind, residuals_CSF_non_carrier)

```

### Amyloid Z-scores

```{r}
# Function to compute z-scores for a list of models based on APOE_binary
compute_z_scores_PET_APOE <- function(model_list, data) {
  for (i in seq_along(model_list)) {
    model <- model_list[[i]]$model
    variable <- model_list[[i]]$dependent_variable
    
    residuals <- residuals(model)
    
    # Get mean and standard deviation from the corresponding columns in the data frame based on APOE_binary
    mean_col <- paste("amyloid_mean_", variable, sep = "")
    sd_col <- paste("amyloid_sd_", variable, sep = "")
    mean_val <- data[[mean_col]][1]
    sd_val <- data[[sd_col]][1]
    
    # Scale residuals by the mean and standard deviation
    z_scores <- scale(residuals, center = mean_val, scale = sd_val)
    
    # Create a new column in the data frame for the scaled z-scores
    z_score_col <- paste(variable, "_z_score_PET_APOE", sep = "")
    
    # Update the data frame with the z_scores
    data <- data %>%
      mutate(!!z_score_col := z_scores)
  }
  
  return(data)
}

# Z-scores for APOE carrier subset
carrier <- compute_z_scores_PET_APOE(carrier_models, carrier)

# Z-scores for non-carrier subset
non_carrier <- compute_z_scores_PET_APOE(non_carrier_models, non_carrier)

```

### Amyloid

```{r}
### Plot of PET amyloid z-scores

# Your list of z_score variables and proxy variables
z_score_PET_APOE <- c("Ab40_plasmaF_SimoaNP4E_BL_z_score_PET_APOE", "Ab42_40_ratio_plasmaF_SimoaNP4E_BL_z_score_PET_APOE", "Ab42_plasmaF_SimoaNP4E_BL_z_score_PET_APOE", "ptau181_plasmaF_Simoa_BL_z_score_PET_APOE", "ptau217_plasmaF_MSDLilly_BL_z_score_PET_APOE", "ptau217_plasmaNF_SimoaJanssen_BL_z_score_PET_APOE", "ptau231_plasmaF_SimoaGot_BL_z_score_PET_APOE", "ttau_plasmaF_MSDLilly_BL_z_score_PET_APOE", "GFAP_plasmaF_SimoaNP4E_BL_z_score_PET_APOE", "NFL_plasmaF_SimoaNP4E_BL_z_score_PET_APOE")

# Define a color palette for z_score variables
color_palette <- rainbow(length(z_score_PET_APOE))

columns_to_multiply <- c("Ab42_40_ratio_plasmaF_SimoaNP4E_BL_z_score_PET_APOE", "Ab42_plasmaF_SimoaNP4E_BL_z_score_PET_APOE")

carrier[, columns_to_multiply] <- carrier[, columns_to_multiply] * -1
non_carrier[, columns_to_multiply] <- non_carrier[, columns_to_multiply] * -1

```

### Carrier

### Individual plots
```{r}
# Create a data frame to store the response variable names
plot_data <- data.frame(z_score_var = rep(z_score_PET_APOE, each = nrow(carrier)),
                        amyloid_PET_CL_BL_complete = rep(carrier$amyloid_PET_CL_BL_complete, times = length(z_score_PET_APOE)),
                        value = as.vector(sapply(z_score_PET_APOE, function(z_var) carrier[[z_var]])))

# Plot ggplot with loess smoothing for each z_score variable
facet_plot <- ggplot(plot_data, aes(x = amyloid_PET_CL_BL_complete, y = value, color = z_score_var)) +
  geom_smooth(method = "loess", span = 0.9, aes(fill = z_score_var), alpha = 0.1) +
  labs(title = "LOESS Regression Amyloid PET Centiloid BL in APOE Carriers",
       x = "amyloid_PET_CL_BL_complete",
       y = "Rate of change (z-score)") +
  scale_color_manual(values = setNames(color_palette, z_score_PET_APOE)) +
  theme_minimal() +
  facet_wrap(~ z_score_var, scales = "free_y")

# Convert ggplot to Plotly
facet_amyloid <- ggplotly(facet_plot)

# Print the Plotly plot
print(facet_amyloid)
```

### Combined plots
```{r}
## Combined plots

# Create a data frame to store the response variable names for carrier subset
plot_data_carrier <- data.frame(z_score_var = rep(z_score_PET_APOE, each = nrow(carrier)),
                                amyloid_PET_CL_BL_complete = rep(carrier$amyloid_PET_CL_BL_complete, times = length(z_score_PET_APOE)),
                                value = as.vector(sapply(z_score_PET_APOE, function(z_var) carrier[[z_var]])))

# Plot ggplot with loess smoothing for each z_score variable for carrier subset
combined_plot_carrier <- ggplot(plot_data_carrier, aes(x = amyloid_PET_CL_BL_complete, y = value, color = z_score_var)) +
  geom_smooth(method = "loess", linetype = 2, span = 0.9, aes(fill = z_score_var), alpha = 0.1, se = FALSE) +
  geom_hline(yintercept = 2, linetype = "solid", alpha = 0.5) +  
  geom_vline(xintercept = 12, linetype = "dotted", alpha = 0.5, color = 'red') +
  annotate("text", x = -10, y = 2.2, label = "2 s.d.", size = 3, fontface = 'bold') +
  labs(title = "Amyloid reference group in APOE-Œµ4 Carriers",
       x = "amyloid_PET_CL_BL_complete",
       y = "Baseline z-scores") +
  scale_color_manual(values = setNames(color_palette, z_score_PET_APOE)) +
  theme_minimal()

# Convert ggplot to plotly plot for carrier subset
combined_amyloid_carrier <- ggplotly(combined_plot_carrier)

# Print the interactive plot for carrier subset
print(combined_amyloid_carrier)

```


### Bootstrapping
```{r}

# Function to fit loess model and calculate coefficients
loess_fit <- function(formula, data, indices) {
  d <- data[indices, ]
  fit <- loess(formula, data = d)
  pred <- predict(fit, newdata = data)
  return(pred)
}

# Bootstrap function to obtain coefficients for each variable
bootstrap_loess_coef <- function(data, formula, nboot = 1000) {
  boot_res <- boot(data, statistic = loess_fit, R = nboot, formula = formula)
  return(boot_res)
}

# List to store bootstrapped coefficients for each variable
boot_results <- list()

# Loop through each variable and perform bootstrapping
for (variable in z_score_PET_APOE) {
  data <- carrier[, c("amyloid_PET_CL_BL_complete", variable)]
  boot_results[[variable]] <- bootstrap_loess_coef(data = data, formula = as.formula(paste(variable, "~ amyloid_PET_CL_BL_complete")))
}

# Access bootstrapped coefficients for each variable
for (variable in z_score_PET_APOE) {
  cat("Bootstrapped coefficients for", variable, ":\n")
}

# Initialize a list to store averaged predictions for each variable
averaged_predictions <- list()

# Loop through each variable to calculate averaged predictions
for (variable in z_score_PET_APOE) {
  cat("Calculating averaged predictions for", variable, ":\n")
  
  # Initialize an empty vector to store predictions from each iteration
  predictions <- numeric(nrow(carrier))
  
  # Extract predictions from each iteration and aggregate them
  for (i in 1:1000) {
    predictions <- predictions + boot_results[[variable]]$t[i,]
  }
  
  # Calculate the average prediction across all iterations
  averaged_predictions[[variable]] <- predictions / 1000
  
  # Print the averaged predictions for each variable
  cat("Averaged predictions for", variable, ":\n")
}

averaged_predictions <- as.data.frame(averaged_predictions)

averaged_predictions$amyloid_PET_CL_BL_complete  <- carrier$amyloid_PET_CL_BL_complete


```


```{r}
# Combined bootstrap plot
gg <- ggplot(data = averaged_predictions, aes(x = amyloid_PET_CL_BL_complete)) +
  geom_smooth(aes(y = Ab40_plasmaF_SimoaNP4E_BL_z_score_PET_APOE, color = "Ab40"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = Ab42_40_ratio_plasmaF_SimoaNP4E_BL_z_score_PET_APOE, color = "Ab42_40_ratio"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = Ab42_plasmaF_SimoaNP4E_BL_z_score_PET_APOE, color = "Ab42"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau181_plasmaF_Simoa_BL_z_score_PET_APOE, color = "ptau181"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau217_plasmaF_MSDLilly_BL_z_score_PET_APOE, color = "ptau217_MSDLilly"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau217_plasmaNF_SimoaJanssen_BL_z_score_PET_APOE, color = "ptau217_SimoaJanssen"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau231_plasmaF_SimoaGot_BL_z_score_PET_APOE, color = "ptau231"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ttau_plasmaF_MSDLilly_BL_z_score_PET_APOE, color = "ttau_MSDLilly"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = GFAP_plasmaF_SimoaNP4E_BL_z_score_PET_APOE, color = "GFAP"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = NFL_plasmaF_SimoaNP4E_BL_z_score_PET_APOE, color = "NFL"), 
              se = FALSE, method = "loess", linetype = 2) +
  labs(title = "Average of Bootstraps for Amyloid reference group in APOE-Œµ4 Carriers",
       x = "amyloid_PET_CL_BL_complete",
       y = "Average of z-score baseline Bootstraps",
       color = "Variable") +
  geom_hline(yintercept = 2, linetype = "solid", alpha = 0.5) +  
  geom_vline(xintercept = 12, linetype = "dotted", alpha = 0.5, color = 'red') +
  theme_minimal()

# Convert ggplot to plotly
plotly_plot <- ggplotly(gg)

# Print the plotly plot
plotly_plot
```


```{r}
# Combined original plot
gg2 <- ggplot(data = carrier, aes(x = amyloid_PET_CL_BL_complete)) +
  geom_smooth(aes(y = Ab40_plasmaF_SimoaNP4E_BL_z_score_PET_APOE, color = "Ab40"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = Ab42_40_ratio_plasmaF_SimoaNP4E_BL_z_score_PET_APOE, color = "Ab42_40_ratio"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = Ab42_plasmaF_SimoaNP4E_BL_z_score_PET_APOE, color = "Ab42"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau181_plasmaF_Simoa_BL_z_score_PET_APOE, color = "ptau181"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau217_plasmaF_MSDLilly_BL_z_score_PET_APOE, color = "ptau217_MSDLilly"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau217_plasmaNF_SimoaJanssen_BL_z_score_PET_APOE, color = "ptau217_SimoaJanssen"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau231_plasmaF_SimoaGot_BL_z_score_PET_APOE, color = "ptau231"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ttau_plasmaF_MSDLilly_BL_z_score_PET_APOE, color = "ttau_MSDLilly"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = GFAP_plasmaF_SimoaNP4E_BL_z_score_PET_APOE, color = "GFAP"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = NFL_plasmaF_SimoaNP4E_BL_z_score_PET_APOE, color = "NFL"), 
              se = FALSE, method = "loess", linetype = 2) +
  labs(title = "Original Amyloid reference group in APOE-Œµ4 Carriers  ",
       x = "amyloid_PET_CL_BL_complete",
       y = "z-scores Baseline",
       color = "Variable") +
  geom_hline(yintercept = 2, linetype = "solid", alpha = 0.5) +  
  geom_vline(xintercept = 12, linetype = "dotted", alpha = 0.5, color = 'red') +
  theme_minimal()

# Convert ggplot to plotly
plotly_plot2 <- ggplotly(gg2)

# Print the plotly plot
plotly_plot2

```



### Non-carrier

### Individual plots

```{r}
# Create a data frame to store the response variable names
plot_data <- data.frame(z_score_var = rep(z_score_PET_APOE, each = nrow(non_carrier)),
                        amyloid_PET_CL_BL_complete = rep(non_carrier$amyloid_PET_CL_BL_complete, times = length(z_score_PET_APOE)),
                        value = as.vector(sapply(z_score_PET_APOE, function(z_var) non_carrier[[z_var]])))

# Plot ggplot with loess smoothing for each z_score variable
facet_plot <- ggplot(plot_data, aes(x = amyloid_PET_CL_BL_complete, y = value, color = z_score_var)) +
  geom_smooth(method = "loess", span = 0.9, aes(fill = z_score_var), alpha = 0.1) +
  labs(title = "Amyloid reference group in APOE-Œµ4 Non-Carriers ",
       x = "amyloid_PET_CL_BL_complete",
       y = "Baseline z-scores") +
  scale_color_manual(values = setNames(color_palette, z_score_PET_APOE)) +
  theme_minimal() +
  facet_wrap(~ z_score_var, scales = "free_y")

# Convert ggplot to Plotly
facet_amyloid <- ggplotly(facet_plot)

# Print the Plotly plot
print(facet_amyloid)
```

### Combined plots

```{r}
# Create a data frame to store the response variable names for non-carrier subset
plot_data_non_carrier <- data.frame(z_score_var = rep(z_score_PET_APOE, each = nrow(non_carrier)),
                                    amyloid_PET_CL_BL_complete = rep(non_carrier$amyloid_PET_CL_BL_complete, times = length(z_score_PET_APOE)),
                                    value = as.vector(sapply(z_score_PET_APOE, function(z_var) non_carrier[[z_var]])))

# Plot ggplot with loess smoothing for each z_score variable for non-carrier subset
combined_plot_non_carrier <- ggplot(plot_data_non_carrier, aes(x = amyloid_PET_CL_BL_complete, y = value, color = z_score_var)) +
  geom_smooth(method = "loess", linetype = 2, span = 0.9, aes(fill = z_score_var), alpha = 0.1, se = FALSE) +
  geom_hline(yintercept = 2, linetype = "solid", alpha = 0.5) +  
  geom_vline(xintercept = 12, linetype = "dotted", alpha = 0.5, color = 'red') +
  annotate("text", x = -10, y = 2.2, label = "2 s.d.", size = 3, fontface = 'bold') +
   labs(title = "Amyloid reference group in APOE-Œµ4 Non-Carriers ",
       x = "amyloid_PET_CL_BL_complete",
       y = "Baseline z-scores") +
  scale_color_manual(values = setNames(color_palette, z_score_PET_APOE)) +
  theme_minimal()

# Convert ggplot to plotly plot for non-carrier subset
combined_amyloid_non_carrier <- ggplotly(combined_plot_non_carrier)

# Print the interactive plot for non-carrier subset
print(combined_amyloid_non_carrier)

```


### Bootstrapping
```{r}

# Function to fit loess model and calculate coefficients
loess_fit <- function(formula, data, indices) {
  d <- data[indices, ]
  fit <- loess(formula, data = d)
  pred <- predict(fit, newdata = data)
  return(pred)
}

# Bootstrap function to obtain coefficients for each variable
bootstrap_loess_coef <- function(data, formula, nboot = 1000) {
  boot_res <- boot(data, statistic = loess_fit, R = nboot, formula = formula)
  return(boot_res)
}

# List to store bootstrapped coefficients for each variable
boot_results <- list()

# Loop through each variable and perform bootstrapping
for (variable in z_score_PET_APOE) {
  data <- non_carrier[, c("amyloid_PET_CL_BL_complete", variable)]
  boot_results[[variable]] <- bootstrap_loess_coef(data = data, formula = as.formula(paste(variable, "~ amyloid_PET_CL_BL_complete")))
}

# Access bootstrapped coefficients for each variable
for (variable in z_score_PET_APOE) {
  cat("Bootstrapped coefficients for", variable, ":\n")
}

# Initialize a list to store averaged predictions for each variable
averaged_predictions <- list()

# Loop through each variable to calculate averaged predictions
for (variable in z_score_PET_APOE) {
  cat("Calculating averaged predictions for", variable, ":\n")
  
  # Initialize an empty vector to store predictions from each iteration
  predictions <- numeric(nrow(non_carrier))
  
  # Extract predictions from each iteration and aggregate them
  for (i in 1:1000) {
    predictions <- predictions + boot_results[[variable]]$t[i,]
  }
  
  # Calculate the average prediction across all iterations
  averaged_predictions[[variable]] <- predictions / 1000
  
  # Print the averaged predictions for each variable
  cat("Averaged predictions for", variable, ":\n")
}

averaged_predictions <- as.data.frame(averaged_predictions)

averaged_predictions$amyloid_PET_CL_BL_complete  <- non_carrier$amyloid_PET_CL_BL_complete



```





```{r}
# Combined bootstrap plot
gg <- ggplot(data = averaged_predictions, aes(x = amyloid_PET_CL_BL_complete)) +
  geom_smooth(aes(y = Ab40_plasmaF_SimoaNP4E_BL_z_score_PET_APOE, color = "Ab40"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = Ab42_40_ratio_plasmaF_SimoaNP4E_BL_z_score_PET_APOE, color = "Ab42_40_ratio"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = Ab42_plasmaF_SimoaNP4E_BL_z_score_PET_APOE, color = "Ab42"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau181_plasmaF_Simoa_BL_z_score_PET_APOE, color = "ptau181"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau217_plasmaF_MSDLilly_BL_z_score_PET_APOE, color = "ptau217_MSDLilly"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau217_plasmaNF_SimoaJanssen_BL_z_score_PET_APOE, color = "ptau217_SimoaJanssen"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau231_plasmaF_SimoaGot_BL_z_score_PET_APOE, color = "ptau231"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ttau_plasmaF_MSDLilly_BL_z_score_PET_APOE, color = "ttau_MSDLilly"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = GFAP_plasmaF_SimoaNP4E_BL_z_score_PET_APOE, color = "GFAP"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = NFL_plasmaF_SimoaNP4E_BL_z_score_PET_APOE, color = "NFL"), 
              se = FALSE, method = "loess", linetype = 2) +
  labs(title = "Average of Bootstraps for Amyloid reference group in APOE-Œµ4 Non-Carriers",
       x = "amyloid_PET_CL_BL_complete",
       y = "Average of z-score baseline Bootstraps",
       color = "Variable") +
  geom_hline(yintercept = 2, linetype = "solid", alpha = 0.5) +  
  geom_vline(xintercept = 12, linetype = "dotted", alpha = 0.5, color = 'red') +
  theme_minimal()

# Convert ggplot to plotly
plotly_plot <- ggplotly(gg)

# Print the plotly plot
plotly_plot
```


```{r}
# Combined original plot
gg2 <- ggplot(data = non_carrier, aes(x = amyloid_PET_CL_BL_complete)) +
  geom_smooth(aes(y = Ab40_plasmaF_SimoaNP4E_BL_z_score_PET_APOE, color = "Ab40"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = Ab42_40_ratio_plasmaF_SimoaNP4E_BL_z_score_PET_APOE, color = "Ab42_40_ratio"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = Ab42_plasmaF_SimoaNP4E_BL_z_score_PET_APOE, color = "Ab42"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau181_plasmaF_Simoa_BL_z_score_PET_APOE, color = "ptau181"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau217_plasmaF_MSDLilly_BL_z_score_PET_APOE, color = "ptau217_MSDLilly"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau217_plasmaNF_SimoaJanssen_BL_z_score_PET_APOE, color = "ptau217_SimoaJanssen"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau231_plasmaF_SimoaGot_BL_z_score_PET_APOE, color = "ptau231"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ttau_plasmaF_MSDLilly_BL_z_score_PET_APOE, color = "ttau_MSDLilly"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = GFAP_plasmaF_SimoaNP4E_BL_z_score_PET_APOE, color = "GFAP"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = NFL_plasmaF_SimoaNP4E_BL_z_score_PET_APOE, color = "NFL"), 
              se = FALSE, method = "loess", linetype = 2) +
  labs(title = "Original Amyloid reference group in APOE-Œµ4 Non-Carriers  ",
       x = "amyloid_PET_CL_BL_complete",
       y = "z-scores Baseline",
       color = "Variable") +
  geom_hline(yintercept = 2, linetype = "solid", alpha = 0.5) +  
  geom_vline(xintercept = 12, linetype = "dotted", alpha = 0.5, color = 'red') +
  theme_minimal()

# Convert ggplot to plotly
plotly_plot2 <- ggplotly(gg2)

# Print the plotly plot
plotly_plot2

```


### CSF ratio z-scores

```{r}
# Function to compute z-scores for a list of models based on CSF AB 42/40 ratio
compute_z_scores_CSF_ABRatio <- function(model_list, data) {
  for (i in seq_along(model_list)) {
    model <- model_list[[i]]$model
    variable <- model_list[[i]]$dependent_variable
    
    residuals <- residuals(model)
    
    # Extract the residuals from the model
    
    # Get mean and standard deviation from the corresponding columns in the data frame based on CSF AB 42/40 ratio
    mean_col <- paste("CSF_mean_", variable, sep = "")
    sd_col <- paste("CSF_sd_", variable, sep = "")
    mean_val <- data[[mean_col]][1]
    sd_val <- data[[sd_col]][1]
    
    # Scale residuals by the mean and standard deviation
    z_scores <- scale(residuals, center = mean_val, scale = sd_val)
    
    # Create a new column in the data frame for the scaled z-scores
    z_score_col <- paste(variable, "_z_score_CSF_ABRatio", sep = "")
    
    # Update the data frame with the z_scores
    data <- data %>%
      mutate(!!z_score_col := z_scores)
  }
  
  return(data)
}

# Apply the function for each list of models
# Z-scores for carrier subset using CSF AB 42/40 ratio reference group
carrier <- compute_z_scores_CSF_ABRatio(carrier_models, carrier)
non_carrier <- compute_z_scores_CSF_ABRatio(non_carrier_models, non_carrier)

# List of CSF z_score variables for AB 42/40 ratio reference group
z_score_CSF_ABRatio <- c("Ab40_plasmaF_SimoaNP4E_BL_z_score_CSF_ABRatio", "Ab42_40_ratio_plasmaF_SimoaNP4E_BL_z_score_CSF_ABRatio", "Ab42_plasmaF_SimoaNP4E_BL_z_score_CSF_ABRatio", "ptau181_plasmaF_Simoa_BL_z_score_CSF_ABRatio", "ptau217_plasmaF_MSDLilly_BL_z_score_CSF_ABRatio", "ptau217_plasmaNF_SimoaJanssen_BL_z_score_CSF_ABRatio", "ptau231_plasmaF_SimoaGot_BL_z_score_CSF_ABRatio", "ttau_plasmaF_MSDLilly_BL_z_score_CSF_ABRatio", "GFAP_plasmaF_SimoaNP4E_BL_z_score_CSF_ABRatio", "NFL_plasmaF_SimoaNP4E_BL_z_score_CSF_ABRatio")

# Color palette for z_score variables
color_palette <- rainbow(length(z_score_CSF_ABRatio))

columns_to_multiply <- c("Ab42_40_ratio_plasmaF_SimoaNP4E_BL_z_score_CSF_ABRatio", "Ab42_plasmaF_SimoaNP4E_BL_z_score_CSF_ABRatio")

carrier[, columns_to_multiply] <- carrier[, columns_to_multiply] * -1
non_carrier[, columns_to_multiply] <- non_carrier[, columns_to_multiply] * -1


```

### Carrier 

### Individual biomarkers plot

```{r}


# Create a data frame to store the response variable names for carrier subset
plot_data_carrier <- data.frame(z_score_var = rep(z_score_CSF_ABRatio, each = nrow(carrier)),
                             ab42_40_ratio_CSFNC_BL = rep(carrier$ab42_40_ratio_CSFNC_BL, times = length(z_score_CSF_ABRatio)),
                             value = as.vector(sapply(z_score_CSF_ABRatio, function(z_var) carrier[[z_var]])))

# Plot ggplot with loess smoothing for each z_score variable for carrier subset
facet_plot_carrier <- ggplot(plot_data_carrier, aes(x = ab42_40_ratio_CSFNC_BL, y = value, color = z_score_var)) +
  geom_smooth(method = "loess", span = 0.9, aes(fill = z_score_var), alpha = 0.1) +
  labs(title = "CSF AB 42/40 ratio as proxy for Carrier",
       x = "ab42_40_ratio_CSFNC_BL",
       y = "Rate of change (z-score)") +
  scale_color_manual(values = setNames(color_palette, z_score_CSF_ABRatio)) +
  theme_minimal() +
  scale_x_continuous(trans = "reverse") +
  facet_wrap(~ z_score_var, scales = "free_y")

# Convert ggplot to interactive plot using ggplotly for carrier subset
facet_CSF_carrier <- ggplotly(facet_plot_carrier)

# Print the interactive plot for carrier subset
print(facet_CSF_carrier)
 
```

### Combined plot

```{r}
### Combined biomarkers plot for carrier subset


plot_data_carrier <- data.frame(z_score_var = rep(z_score_CSF_ABRatio, each = nrow(carrier)),
                                ab42_40_ratio_CSFNC_BL = rep(carrier$ab42_40_ratio_CSFNC_BL, times = length(z_score_CSF_ABRatio)),
                                value = as.vector(sapply(z_score_CSF_ABRatio, function(z_var) carrier[[z_var]])))

# Plot ggplot with loess smoothing for each z_score variable for carrier subset
combined_plot_carrier <- ggplot(plot_data_carrier, aes(x = ab42_40_ratio_CSFNC_BL, y = value, color = z_score_var)) +
  geom_smooth(method = "loess", linetype = 2, span = 0.9, aes(fill = z_score_var), alpha = 0.1, se = FALSE) +
  geom_hline(yintercept = 2, linetype = "solid", alpha = 0.5) +  
  geom_vline(xintercept = 0.071, linetype = "dotted", alpha = 0.5, color = 'red') +
  annotate("text", x = 0.1, y = 2.2, label = "2 s.d.", size = 3, fontface = 'bold') +
  labs(title = "CSF reference group in APOE-Œµ4 carriers",
       x = "ab42/40 ratio CSFNC Baseline",
       y = "Baseline z-scores") +
  scale_color_manual(values = setNames(color_palette, z_score_CSF_ABRatio)) +
  scale_x_continuous(trans = "reverse") +
  theme_minimal()

# Convert ggplot to interactive plot using ggplotly for carrier subset
combined_CSF_carrier <- ggplotly(combined_plot_carrier)

# Print the interactive plot for carrier subset
print(combined_CSF_carrier)

```

### Bootstrapping
```{r}

# Function to fit loess model and calculate coefficients
loess_fit <- function(formula, data, indices) {
  d <- data[indices, ]
  fit <- loess(formula, data = d)
  pred <- predict(fit, newdata = data)
  return(pred)
}

# Bootstrap function to obtain coefficients for each variable
bootstrap_loess_coef <- function(data, formula, nboot = 1000) {
  boot_res <- boot(data, statistic = loess_fit, R = nboot, formula = formula)
  return(boot_res)
}

# List to store bootstrapped coefficients for each variable
boot_results <- list()

# Loop through each variable and perform bootstrapping
for (variable in z_score_CSF_ABRatio) {
  data <- carrier[, c("ab42_40_ratio_CSFNC_BL", variable)]
  boot_results[[variable]] <- bootstrap_loess_coef(data = data, formula = as.formula(paste(variable, "~ ab42_40_ratio_CSFNC_BL")))
}

# Access bootstrapped coefficients for each variable
for (variable in z_score_CSF_ABRatio) {
  cat("Bootstrapped coefficients for", variable, ":\n")
}

# Initialize a list to store averaged predictions for each variable
averaged_predictions <- list()

# Loop through each variable to calculate averaged predictions
for (variable in z_score_CSF_ABRatio) {
  cat("Calculating averaged predictions for", variable, ":\n")
  
  # Initialize an empty vector to store predictions from each iteration
  predictions <- numeric(nrow(carrier))
  
  # Extract predictions from each iteration and aggregate them
  for (i in 1:1000) {
    predictions <- predictions + boot_results[[variable]]$t[i,]
  }
  
  # Calculate the average prediction across all iterations
  averaged_predictions[[variable]] <- predictions / 1000
  
  # Print the averaged predictions for each variable
  cat("Averaged predictions for", variable, ":\n")
}

averaged_predictions <- as.data.frame(averaged_predictions)

averaged_predictions$ab42_40_ratio_CSFNC_BL  <- carrier$ab42_40_ratio_CSFNC_BL



```



```{r}
# Combined bootstrap plot
gg <- ggplot(data = averaged_predictions, aes(x = ab42_40_ratio_CSFNC_BL)) +
  geom_smooth(aes(y = Ab40_plasmaF_SimoaNP4E_BL_z_score_CSF_ABRatio, color = "Ab40"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = Ab42_40_ratio_plasmaF_SimoaNP4E_BL_z_score_CSF_ABRatio, color = "Ab42_40_ratio"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = Ab42_plasmaF_SimoaNP4E_BL_z_score_CSF_ABRatio, color = "Ab42"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau181_plasmaF_Simoa_BL_z_score_CSF_ABRatio, color = "ptau181"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau217_plasmaF_MSDLilly_BL_z_score_CSF_ABRatio, color = "ptau217_MSDLilly"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau217_plasmaNF_SimoaJanssen_BL_z_score_CSF_ABRatio, color = "ptau217_SimoaJanssen"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau231_plasmaF_SimoaGot_BL_z_score_CSF_ABRatio, color = "ptau231"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ttau_plasmaF_MSDLilly_BL_z_score_CSF_ABRatio, color = "ttau_MSDLilly"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = GFAP_plasmaF_SimoaNP4E_BL_z_score_CSF_ABRatio, color = "GFAP"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = NFL_plasmaF_SimoaNP4E_BL_z_score_CSF_ABRatio, color = "NFL"), 
              se = FALSE, method = "loess", linetype = 2) +
  labs(title = "Average of Bootstraps for CSF reference group in APOE-E4 carriers",
       x = "ab42/40 ratio CSFNC Baseline",
       y = "Average of z-score baseline bootstraps",
       color = "Variable") +
  geom_hline(yintercept = 2, linetype = "solid", alpha = 0.5) +  
  geom_vline(xintercept = 0.071, linetype = "dotted", alpha = 0.5, color = 'red') +
  scale_x_continuous(trans = "reverse") +
  theme_minimal()

# Convert ggplot to plotly
plotly_plot <- ggplotly(gg)

# Print the plotly plot
plotly_plot
```


```{r}
# Combined original plot
gg2 <- ggplot(data = carrier, aes(x = ab42_40_ratio_CSFNC_BL)) +
  geom_smooth(aes(y = Ab40_plasmaF_SimoaNP4E_BL_z_score_CSF_ABRatio, color = "Ab40"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = Ab42_40_ratio_plasmaF_SimoaNP4E_BL_z_score_CSF_ABRatio, color = "Ab42_40_ratio"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = Ab42_plasmaF_SimoaNP4E_BL_z_score_CSF_ABRatio, color = "Ab42"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau181_plasmaF_Simoa_BL_z_score_CSF_ABRatio, color = "ptau181"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau217_plasmaF_MSDLilly_BL_z_score_CSF_ABRatio, color = "ptau217_MSDLilly"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau217_plasmaNF_SimoaJanssen_BL_z_score_CSF_ABRatio, color = "ptau217_SimoaJanssen"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau231_plasmaF_SimoaGot_BL_z_score_CSF_ABRatio, color = "ptau231"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ttau_plasmaF_MSDLilly_BL_z_score_CSF_ABRatio, color = "ttau_MSDLilly"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = GFAP_plasmaF_SimoaNP4E_BL_z_score_CSF_ABRatio, color = "GFAP"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = NFL_plasmaF_SimoaNP4E_BL_z_score_CSF_ABRatio, color = "NFL"), 
              se = FALSE, method = "loess", linetype = 2) +
  labs(title = "Original CSF reference group in APOE-E4 carriers  ",
       x = "ab42/40 ratio CSFNC Baseline",
       y = "z-scores Baseline",
       color = "Variable") +
  geom_hline(yintercept = 2, linetype = "solid", alpha = 0.5) +  
  geom_vline(xintercept = 0.071, linetype = "dotted", alpha = 0.5, color = 'red') +
  scale_x_continuous(trans = "reverse") +
  theme_minimal()

# Convert ggplot to plotly
plotly_plot2 <- ggplotly(gg2)

# Print the plotly plot
plotly_plot2

```


### Non-Carrier 

### Individual biomarkers plot

```{r}


# Create a data frame to store the response variable names for non-carrier subset
plot_data_non_carrier <- data.frame(z_score_var = rep(z_score_CSF_ABRatio, each = nrow(non_carrier)),
                                    ab42_40_ratio_CSFNC_BL = rep(non_carrier$ab42_40_ratio_CSFNC_BL, times = length(z_score_CSF_ABRatio)),
                                    value = as.vector(sapply(z_score_CSF_ABRatio, function(z_var) non_carrier[[z_var]])))

# Plot ggplot with loess smoothing for each z_score variable for non-carrier subset
facet_plot_non_carrier <- ggplot(plot_data_non_carrier, aes(x = ab42_40_ratio_CSFNC_BL, y = value, color = z_score_var)) +
  geom_smooth(method = "loess", span = 0.9, aes(fill = z_score_var), alpha = 0.1) +
  labs(title = "CSF AB 42/40 ratio as proxy for Non-Carrier",
       x = "ab42_40_ratio_CSFNC_BL",
       y = "Baseline Levels") +
  scale_color_manual(values = setNames(color_palette, z_score_CSF_ABRatio)) +
  theme_minimal() +
  scale_x_continuous(trans = "reverse") +
  facet_wrap(~ z_score_var, scales = "free_y")

# Convert ggplot to interactive plot using ggplotly for non-carrier subset
facet_CSF_non_carrier <- ggplotly(facet_plot_non_carrier)

# Print the interactive plot for non-carrier subset
print(facet_CSF_non_carrier)

```

### Combined plot
```{r}
### Combined biomarkers plot for non-carrier subset

# Create a data frame to store the response variable names for non-carrier subset
plot_data_non_carrier <- data.frame(z_score_var = rep(z_score_CSF_ABRatio, each = nrow(non_carrier)),
                                    ab42_40_ratio_CSFNC_BL = rep(non_carrier$ab42_40_ratio_CSFNC_BL, times = length(z_score_CSF_ABRatio)),
                                    value = as.vector(sapply(z_score_CSF_ABRatio, function(z_var) non_carrier[[z_var]])))

# Plot ggplot with loess smoothing for each z_score variable for non-carrier subset
combined_plot_non_carrier <- ggplot(plot_data_non_carrier, aes(x = ab42_40_ratio_CSFNC_BL, y = value, color = z_score_var)) +
  geom_smooth(method = "loess", linetype = 2, span = 0.9, aes(fill = z_score_var), alpha = 0.1, se = FALSE) +
  geom_hline(yintercept = 2, linetype = "solid", alpha = 0.5) +  
  geom_vline(xintercept = 0.071, linetype = "dotted", alpha = 0.5, color = 'red') +
  annotate("text", x = 0.1, y = 2.2, label = "2 s.d.", size = 3, fontface = 'bold') +
  labs(title = "CSF reference group in APOE-Œµ4 non-carriers",
       x = "ab42/40 ratio CSFNC Baseline",
       y = "Baseline z-scores") +
  scale_color_manual(values = setNames(color_palette, z_score_CSF_ABRatio)) +
  scale_x_continuous(trans = "reverse") +
  theme_minimal()

# Convert ggplot to interactive plot using ggplotly for non-carrier subset
combined_CSF_non_carrier <- ggplotly(combined_plot_non_carrier)

# Print the interactive plot for non-carrier subset
print(combined_CSF_non_carrier)
```


### Bootstrapping
```{r}

# Function to fit loess model and calculate coefficients
loess_fit <- function(formula, data, indices) {
  d <- data[indices, ]
  fit <- loess(formula, data = d)
  pred <- predict(fit, newdata = data)
  return(pred)
}

# Bootstrap function to obtain coefficients for each variable
bootstrap_loess_coef <- function(data, formula, nboot = 1000) {
  boot_res <- boot(data, statistic = loess_fit, R = nboot, formula = formula)
  return(boot_res)
}

# List to store bootstrapped coefficients for each variable
boot_results <- list()

# Loop through each variable and perform bootstrapping
for (variable in z_score_CSF_ABRatio) {
  data <- non_carrier[, c("ab42_40_ratio_CSFNC_BL", variable)]
  boot_results[[variable]] <- bootstrap_loess_coef(data = data, formula = as.formula(paste(variable, "~ ab42_40_ratio_CSFNC_BL")))
}

# Access bootstrapped coefficients for each variable
for (variable in z_score_CSF_ABRatio) {
  cat("Bootstrapped coefficients for", variable, ":\n")
}

# Initialize a list to store averaged predictions for each variable
averaged_predictions <- list()

# Loop through each variable to calculate averaged predictions
for (variable in z_score_CSF_ABRatio) {
  cat("Calculating averaged predictions for", variable, ":\n")
  
  # Initialize an empty vector to store predictions from each iteration
  predictions <- numeric(nrow(non_carrier))
  
  # Extract predictions from each iteration and aggregate them
  for (i in 1:1000) {
    predictions <- predictions + boot_results[[variable]]$t[i,]
  }
  
  # Calculate the average prediction across all iterations
  averaged_predictions[[variable]] <- predictions / 1000
}

averaged_predictions <- as.data.frame(averaged_predictions)

averaged_predictions$ab42_40_ratio_CSFNC_BL  <- non_carrier$ab42_40_ratio_CSFNC_BL



```



```{r}
# Combined bootstrap plot
gg <- ggplot(data = averaged_predictions, aes(x = ab42_40_ratio_CSFNC_BL)) +
  geom_smooth(aes(y = Ab40_plasmaF_SimoaNP4E_BL_z_score_CSF_ABRatio, color = "Ab40"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = Ab42_40_ratio_plasmaF_SimoaNP4E_BL_z_score_CSF_ABRatio, color = "Ab42_40_ratio"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = Ab42_plasmaF_SimoaNP4E_BL_z_score_CSF_ABRatio, color = "Ab42"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau181_plasmaF_Simoa_BL_z_score_CSF_ABRatio, color = "ptau181"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau217_plasmaF_MSDLilly_BL_z_score_CSF_ABRatio, color = "ptau217_MSDLilly"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau217_plasmaNF_SimoaJanssen_BL_z_score_CSF_ABRatio, color = "ptau217_SimoaJanssen"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau231_plasmaF_SimoaGot_BL_z_score_CSF_ABRatio, color = "ptau231"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ttau_plasmaF_MSDLilly_BL_z_score_CSF_ABRatio, color = "ttau_MSDLilly"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = GFAP_plasmaF_SimoaNP4E_BL_z_score_CSF_ABRatio, color = "GFAP"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = NFL_plasmaF_SimoaNP4E_BL_z_score_CSF_ABRatio, color = "NFL"), 
              se = FALSE, method = "loess", linetype = 2) +
  labs(title = "Average of Bootstraps for CSF reference group in APOE-E4 non-carriers",
       x = "ab42/40 ratio CSFNC Baseline",
       y = "Average of z-score baseline bootstraps",
       color = "Variable") +
  geom_hline(yintercept = 2, linetype = "solid", alpha = 0.5) +  
  geom_vline(xintercept = 0.071, linetype = "dotted", alpha = 0.5, color = 'red') +
  scale_x_continuous(trans = "reverse") +
  theme_minimal()

# Convert ggplot to plotly
plotly_plot <- ggplotly(gg)

# Print the plotly plot
plotly_plot
```


```{r}
# Combined original plot
gg2 <- ggplot(data = non_carrier, aes(x = ab42_40_ratio_CSFNC_BL)) +
  geom_smooth(aes(y = Ab40_plasmaF_SimoaNP4E_BL_z_score_CSF_ABRatio, color = "Ab40"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = Ab42_40_ratio_plasmaF_SimoaNP4E_BL_z_score_CSF_ABRatio, color = "Ab42_40_ratio"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = Ab42_plasmaF_SimoaNP4E_BL_z_score_CSF_ABRatio, color = "Ab42"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau181_plasmaF_Simoa_BL_z_score_CSF_ABRatio, color = "ptau181"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau217_plasmaF_MSDLilly_BL_z_score_CSF_ABRatio, color = "ptau217_MSDLilly"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau217_plasmaNF_SimoaJanssen_BL_z_score_CSF_ABRatio, color = "ptau217_SimoaJanssen"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau231_plasmaF_SimoaGot_BL_z_score_CSF_ABRatio, color = "ptau231"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ttau_plasmaF_MSDLilly_BL_z_score_CSF_ABRatio, color = "ttau_MSDLilly"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = GFAP_plasmaF_SimoaNP4E_BL_z_score_CSF_ABRatio, color = "GFAP"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = NFL_plasmaF_SimoaNP4E_BL_z_score_CSF_ABRatio, color = "NFL"), 
              se = FALSE, method = "loess", linetype = 2) +
  labs(title = "Original CSF reference group in APOE-E4 non-carriers  ",
       x = "ab42/40 ratio CSFNC Baseline",
       y = "z-scores Baseline",
       color = "Variable") +
  geom_hline(yintercept = 2, linetype = "solid", alpha = 0.5) +  
  geom_vline(xintercept = 0.071, linetype = "dotted", alpha = 0.5, color = 'red') +
  scale_x_continuous(trans = "reverse") +
  theme_minimal()

# Convert ggplot to plotly
plotly_plot2 <- ggplotly(gg2)

# Print the plotly plot
plotly_plot2

```

### AGE


```{r}
# APOE, Age models

# Function for multiple regression
perform_mult_regression <- function(data, dependent_variable, covariates) {
  formula <- as.formula(paste(dependent_variable, "~", paste(covariates, collapse = "+")))
  model <- lm(formula, data = data, na.action = 'na.exclude')
  result <- list(
    dependent_variable = dependent_variable,
    model = model,
    summary_result = summary(model)
  )
  return(result)
}

covariates <- "Sex"

# Carrier model
carrier_age_models <- vector("list", length = 10)

for (i in seq_along(baseline_cols)) {
  variable <- baseline_cols[i]
  model_result <- perform_mult_regression(carrier, variable, covariates)
  carrier_age_models[[i]] <- model_result
}

# Non-carrier model
non_carrier_age_models <- vector("list", length = 10)

for (i in seq_along(baseline_cols)) {
  variable <- baseline_cols[i]
  model_result <- perform_mult_regression(non_carrier, variable, covariates)
  non_carrier_age_models[[i]] <- model_result
}

```



```{r}
# APOE, Age reference groups

## Carrier age quantiles
quantile(biomark_df$Age_V1S1, probs = 0.10, na.rm = TRUE) # 54.31 

## Non-carrier age quantiles
quantile(biomark_df$Age_V1S1, probs = 0.10, na.rm = TRUE) # 54.31  

# Carrier reference groups

# Carrier age
residuals_age_carrier <- list()
for (i in seq_along(carrier_age_models)) {
  model <- carrier_age_models[[i]]$model
  residuals_subset <- residuals(model)[biomark_df$Age_V1S1 < 54.31]
  residuals_mean <- mean(residuals_subset, na.rm = TRUE)
  residuals_sd <- sd(residuals_subset, na.rm = TRUE)
  
  residuals_age_carrier[[i]] <- list(
    model_name = carrier_age_models[[i]]$dependent_variable,
    residuals_mean = residuals_mean,
    residuals_sd = residuals_sd
  )
  carrier[paste0("age_mean_", carrier_age_models[[i]]$dependent_variable)] <- residuals_mean
  carrier[paste0("age_sd_", carrier_age_models[[i]]$dependent_variable)] <- residuals_sd
}
age_carrier_df <- do.call(rbind, residuals_age_carrier)

# Non carrier age
residuals_age_noncarrier <- list()
for (i in seq_along(non_carrier_age_models)) {
  model <- non_carrier_age_models[[i]]$model
  residuals_subset <- residuals(model)[biomark_df$Age_V1S1 < 54.31]
  residuals_mean <- mean(residuals_subset, na.rm = TRUE)
  residuals_sd <- sd(residuals_subset, na.rm = TRUE)
  
  residuals_age_noncarrier[[i]] <- list(
    model_name = non_carrier_age_models[[i]]$dependent_variable,
    residuals_mean = residuals_mean,
    residuals_sd = residuals_sd
  )
  non_carrier[paste0("age_mean_", non_carrier_age_models[[i]]$dependent_variable)] <- residuals_mean
  non_carrier[paste0("age_sd_", non_carrier_age_models[[i]]$dependent_variable)] <- residuals_sd
}
age_noncarrier_df <- do.call(rbind, residuals_age_noncarrier)

```



```{r}
# Compute z-scores for APOE and Age models
compute_z_scores_AGE_APOE <- function(model_list, data) {
  for (i in seq_along(model_list)) {
    model <- model_list[[i]]$model
    variable <- model_list[[i]]$dependent_variable
    
    residuals <- residuals(model)
    
    # Get mean and standard deviation
    mean_col <- paste("age_mean_", variable, sep = "")
    sd_col <- paste("age_sd_", variable, sep = "")
    mean_val <- data[[mean_col]][1]
    sd_val <- data[[sd_col]][1]
    
    # Scale residuals by the mean and standard deviation
    z_scores <- scale(residuals, center = mean_val, scale = sd_val)
    
    # Create a new column in the data frame for the scaled z-scores
    z_score_col <- paste(variable, "_z_score_AGE_APOE", sep = "")
    
    # Update the data frame with the z_scores
    data <- data %>%
      mutate(!!z_score_col := z_scores)
  }
  
  return(data)
}

# Z-scores for APOE carrier subset
carrier <- compute_z_scores_AGE_APOE(carrier_age_models, carrier)

# Z-scores for non-carrier subset
non_carrier <- compute_z_scores_AGE_APOE(non_carrier_age_models, non_carrier)

```



```{r}

# Your list of z_score variables and proxy variables
z_score_AGE_APOE <- c("Ab40_plasmaF_SimoaNP4E_BL_z_score_AGE_APOE",            
 "Ab42_40_ratio_plasmaF_SimoaNP4E_BL_z_score_AGE_APOE",   
 "Ab42_plasmaF_SimoaNP4E_BL_z_score_AGE_APOE",            
 "ptau181_plasmaF_Simoa_BL_z_score_AGE_APOE",             
 "ptau217_plasmaF_MSDLilly_BL_z_score_AGE_APOE",          
 "ptau217_plasmaNF_SimoaJanssen_BL_z_score_AGE_APOE",     
 "ptau231_plasmaF_SimoaGot_BL_z_score_AGE_APOE",          
 "ttau_plasmaF_MSDLilly_BL_z_score_AGE_APOE",             
 "GFAP_plasmaF_SimoaNP4E_BL_z_score_AGE_APOE",           
 "NFL_plasmaF_SimoaNP4E_BL_z_score_AGE_APOE")
   

# Define a color palette for z_score variables
color_palette <- rainbow(length(z_score_AGE_APOE))

columns_to_multiply <- c("Ab42_40_ratio_plasmaF_SimoaNP4E_BL_z_score_AGE_APOE", "Ab42_plasmaF_SimoaNP4E_BL_z_score_AGE_APOE")

carrier[, columns_to_multiply] <- carrier[, columns_to_multiply] * -1
non_carrier[, columns_to_multiply] <- non_carrier[, columns_to_multiply] * -1

```



### Carrier Age

```{r}

## Combined plots

plot_data_carrier <- data.frame(z_score_var = rep(z_score_AGE_APOE, each = nrow(carrier)),
                                Age_V1S1 = rep(carrier$Age_V1S1, times = length(z_score_AGE_APOE)),
                                value = as.vector(sapply(z_score_AGE_APOE, function(z_var) carrier[[z_var]])))


# Plot ggplot with loess smoothing for each z_score variable for carrier subset
combined_plot_carrier_age <- ggplot(plot_data_carrier, aes(x = Age_V1S1, y = value, color = z_score_var)) +
  geom_smooth(method = "loess", linetype = 2, span = 0.9, aes(fill = z_score_var), alpha = 0.1, se = FALSE) +
  geom_hline(yintercept = 2, linetype = "solid", alpha = 0.5) +  
  geom_vline(xintercept = 54.31, linetype = "dotted", alpha = 0.5, color = 'red') +
  annotate("text", x = 0.1, y = 2.2, label = "2 s.d.", size = 3, fontface = 'bold') +
  labs(title = "Age reference group in APOE-Œµ4 carriers",
       x = "Age V1S1",
       y = "Baseline z-scores)") +
  scale_color_manual(values = setNames(color_palette, z_score_AGE_APOE)) +
  theme_minimal() +
  xlim(49, 75)

# Convert ggplot to plotly plot for carrier subset
combined_age_carrier <- ggplotly(combined_plot_carrier_age)

# Print the interactive plot for carrier subset
combined_age_carrier



```


### Bootstrapping
```{r}

# Function to fit loess model and calculate coefficients
loess_fit <- function(formula, data, indices) {
  d <- data[indices, ]
  fit <- loess(formula, data = d)
  pred <- predict(fit, newdata = data)
  return(pred)
}

# Bootstrap function to obtain coefficients for each variable
bootstrap_loess_coef <- function(data, formula, nboot = 1000) {
  boot_res <- boot(data, statistic = loess_fit, R = nboot, formula = formula)
  return(boot_res)
}

# List to store bootstrapped coefficients for each variable
boot_results <- list()

# Loop through each variable and perform bootstrapping
for (variable in z_score_AGE_APOE) {
  data <- carrier[, c("Age_V1S1", variable)]
  boot_results[[variable]] <- bootstrap_loess_coef(data = data, formula = as.formula(paste(variable, "~ Age_V1S1")))
}

# Access bootstrapped coefficients for each variable
for (variable in z_score_AGE_APOE) {
  cat("Bootstrapped coefficients for", variable, ":\n")
}

# Initialize a list to store averaged predictions for each variable
averaged_predictions <- list()

# Loop through each variable to calculate averaged predictions
for (variable in z_score_AGE_APOE) {
  
  # Initialize an empty vector to store predictions from each iteration
  predictions <- numeric(nrow(carrier))
  
  # Extract predictions from each iteration and aggregate them
  for (i in 1:1000) {
    predictions <- predictions + boot_results[[variable]]$t[i,]
  }
  
  # Calculate the average prediction across all iterations
  averaged_predictions[[variable]] <- predictions / 1000
}

averaged_predictions <- as.data.frame(averaged_predictions)

averaged_predictions$Age_V1S1  <- carrier$Age_V1S1


```



```{r}
# Combined bootstrap plot
gg <- ggplot(data = averaged_predictions, aes(x = Age_V1S1)) +
  geom_smooth(aes(y = Ab40_plasmaF_SimoaNP4E_BL_z_score_AGE_APOE, color = "Ab40"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = Ab42_40_ratio_plasmaF_SimoaNP4E_BL_z_score_AGE_APOE, color = "Ab42_40_ratio"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = Ab42_plasmaF_SimoaNP4E_BL_z_score_AGE_APOE, color = "Ab42"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau181_plasmaF_Simoa_BL_z_score_AGE_APOE, color = "ptau181"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau217_plasmaF_MSDLilly_BL_z_score_AGE_APOE, color = "ptau217_MSDLilly"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau217_plasmaNF_SimoaJanssen_BL_z_score_AGE_APOE, color = "ptau217_SimoaJanssen"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau231_plasmaF_SimoaGot_BL_z_score_AGE_APOE, color = "ptau231"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ttau_plasmaF_MSDLilly_BL_z_score_AGE_APOE, color = "ttau_MSDLilly"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = GFAP_plasmaF_SimoaNP4E_BL_z_score_AGE_APOE, color = "GFAP"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = NFL_plasmaF_SimoaNP4E_BL_z_score_AGE_APOE, color = "NFL"), 
              se = FALSE, method = "loess", linetype = 2) +
  labs(title = "Average of Bootstraps for Age reference group in APOE-Œµ4 carriers",
       x = "Age visit 1",
       y = "Average of z-score baseline Bootstraps",
       color = "Variable") +
  geom_hline(yintercept = 2, linetype = "solid", alpha = 0.5) +  
  geom_vline(xintercept = 54.31, linetype = "dotted", alpha = 0.5, color = 'red') +
  theme_minimal()

# Convert ggplot to plotly
plotly_plot <- ggplotly(gg)

# Print the plotly plot
plotly_plot
```


```{r}
# Combined original plot
gg2 <- ggplot(data = carrier, aes(x = Age_V1S1)) +
  geom_smooth(aes(y = Ab40_plasmaF_SimoaNP4E_BL_z_score_AGE_APOE, color = "Ab40"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = Ab42_40_ratio_plasmaF_SimoaNP4E_BL_z_score_AGE_APOE, color = "Ab42_40_ratio"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = Ab42_plasmaF_SimoaNP4E_BL_z_score_AGE_APOE, color = "Ab42"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau181_plasmaF_Simoa_BL_z_score_AGE_APOE, color = "ptau181"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau217_plasmaF_MSDLilly_BL_z_score_AGE_APOE, color = "ptau217_MSDLilly"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau217_plasmaNF_SimoaJanssen_BL_z_score_AGE_APOE, color = "ptau217_SimoaJanssen"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau231_plasmaF_SimoaGot_BL_z_score_AGE_APOE, color = "ptau231"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ttau_plasmaF_MSDLilly_BL_z_score_AGE_APOE, color = "ttau_MSDLilly"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = GFAP_plasmaF_SimoaNP4E_BL_z_score_AGE_APOE, color = "GFAP"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = NFL_plasmaF_SimoaNP4E_BL_z_score_AGE_APOE, color = "NFL"), 
              se = FALSE, method = "loess", linetype = 2) +
  labs(title = "Original Age reference group in APOE-Œµ4 carriers  ",
       x = "Age visit 1",
       y = "z-scores Baseline",
       color = "Variable") +
  geom_hline(yintercept = 2, linetype = "solid", alpha = 0.5) +  
  geom_vline(xintercept = 54.31, linetype = "dotted", alpha = 0.5, color = 'red') +
  theme_minimal()

# Convert ggplot to plotly
plotly_plot2 <- ggplotly(gg2)

# Print the plotly plot
plotly_plot2

```



### Non-Carrier Age

```{r}
### Combined plot

## Combined plots

plot_data_non_carrier <- data.frame(z_score_var = rep(z_score_AGE_APOE, each = nrow(non_carrier)),
                                Age_V1S1 = rep(non_carrier$Age_V1S1, times = length(z_score_AGE_APOE)),
                                value = as.vector(sapply(z_score_AGE_APOE, function(z_var) non_carrier[[z_var]])))


# Plot ggplot with loess smoothing for each z_score variable for carrier subset
combined_plot_non_carrier_age <- ggplot(plot_data_non_carrier, aes(x = Age_V1S1, y = value, color = z_score_var)) +
  geom_smooth(method = "loess", linetype = 2, span = 0.9, aes(fill = z_score_var), alpha = 0.1, se = FALSE) +
  geom_hline(yintercept = 2, linetype = "solid", alpha = 0.5) +  
  geom_vline(xintercept = 54.31, linetype = "dotted", alpha = 0.5, color = 'red') +
  annotate("text", x = 0.1, y = 2.2, label = "2 s.d.", size = 3, fontface = 'bold') +
  labs(title = "Age reference group in APOE-Œµ4 non-carriers",
       x = "Age V1S1",
       y = "Baseline z-scores") +
  scale_color_manual(values = setNames(color_palette, z_score_AGE_APOE)) +
  theme_minimal() +
  xlim(49, 75)

# Convert ggplot to plotly plot for carrier subset
combined_age_non_carrier <- ggplotly(combined_plot_non_carrier_age)

# Print the interactive plot for carrier subset
combined_age_non_carrier

```


### Bootstrapping
```{r}

# Function to fit loess model and calculate coefficients
loess_fit <- function(formula, data, indices) {
  d <- data[indices, ]
  fit <- loess(formula, data = d)
  pred <- predict(fit, newdata = data)
  return(pred)
}

# Bootstrap function to obtain coefficients for each variable
bootstrap_loess_coef <- function(data, formula, nboot = 1000) {
  boot_res <- boot(data, statistic = loess_fit, R = nboot, formula = formula)
  return(boot_res)
}

# List to store bootstrapped coefficients for each variable
boot_results <- list()

# Loop through each variable and perform bootstrapping
for (variable in z_score_AGE_APOE) {
  data <- non_carrier[, c("Age_V1S1", variable)]
  boot_results[[variable]] <- bootstrap_loess_coef(data = data, formula = as.formula(paste(variable, "~ Age_V1S1")))
}

# Access bootstrapped coefficients for each variable
for (variable in z_score_AGE_APOE) {
  cat("Bootstrapped coefficients for", variable, ":\n")
}

# Initialize a list to store averaged predictions for each variable
averaged_predictions <- list()

# Loop through each variable to calculate averaged predictions
for (variable in z_score_AGE_APOE) {
  
  # Initialize an empty vector to store predictions from each iteration
  predictions <- numeric(nrow(non_carrier))
  
  # Extract predictions from each iteration and aggregate them
  for (i in 1:1000) {
    predictions <- predictions + boot_results[[variable]]$t[i,]
  }
  
  # Calculate the average prediction across all iterations
  averaged_predictions[[variable]] <- predictions / 1000
}

averaged_predictions <- as.data.frame(averaged_predictions)

averaged_predictions$Age_V1S1  <- non_carrier$Age_V1S1


```



```{r}
# Combined bootstrap plot
gg <- ggplot(data = averaged_predictions, aes(x = Age_V1S1)) +
  geom_smooth(aes(y = Ab40_plasmaF_SimoaNP4E_BL_z_score_AGE_APOE, color = "Ab40"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = Ab42_40_ratio_plasmaF_SimoaNP4E_BL_z_score_AGE_APOE, color = "Ab42_40_ratio"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = Ab42_plasmaF_SimoaNP4E_BL_z_score_AGE_APOE, color = "Ab42"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau181_plasmaF_Simoa_BL_z_score_AGE_APOE, color = "ptau181"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau217_plasmaF_MSDLilly_BL_z_score_AGE_APOE, color = "ptau217_MSDLilly"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau217_plasmaNF_SimoaJanssen_BL_z_score_AGE_APOE, color = "ptau217_SimoaJanssen"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau231_plasmaF_SimoaGot_BL_z_score_AGE_APOE, color = "ptau231"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ttau_plasmaF_MSDLilly_BL_z_score_AGE_APOE, color = "ttau_MSDLilly"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = GFAP_plasmaF_SimoaNP4E_BL_z_score_AGE_APOE, color = "GFAP"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = NFL_plasmaF_SimoaNP4E_BL_z_score_AGE_APOE, color = "NFL"), 
              se = FALSE, method = "loess", linetype = 2) +
  labs(title = "Average of Bootstraps for Age reference group in APOE-E4 non-carriers",
       x = "Age visit 1",
       y = "Average of z-score baseline Bootstraps",
       color = "Variable") +
  geom_hline(yintercept = 2, linetype = "solid", alpha = 0.5) +  
  geom_vline(xintercept = 54.31, linetype = "dotted", alpha = 0.5, color = 'red') +
  theme_minimal()

# Convert ggplot to plotly
plotly_plot <- ggplotly(gg)

# Print the plotly plot
plotly_plot
```


```{r}
# Combined original plot
gg2 <- ggplot(data = non_carrier, aes(x = Age_V1S1)) +
  geom_smooth(aes(y = Ab40_plasmaF_SimoaNP4E_BL_z_score_AGE_APOE, color = "Ab40"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = Ab42_40_ratio_plasmaF_SimoaNP4E_BL_z_score_AGE_APOE, color = "Ab42_40_ratio"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = Ab42_plasmaF_SimoaNP4E_BL_z_score_AGE_APOE, color = "Ab42"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau181_plasmaF_Simoa_BL_z_score_AGE_APOE, color = "ptau181"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau217_plasmaF_MSDLilly_BL_z_score_AGE_APOE, color = "ptau217_MSDLilly"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau217_plasmaNF_SimoaJanssen_BL_z_score_AGE_APOE, color = "ptau217_SimoaJanssen"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau231_plasmaF_SimoaGot_BL_z_score_AGE_APOE, color = "ptau231"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ttau_plasmaF_MSDLilly_BL_z_score_AGE_APOE, color = "ttau_MSDLilly"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = GFAP_plasmaF_SimoaNP4E_BL_z_score_AGE_APOE, color = "GFAP"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = NFL_plasmaF_SimoaNP4E_BL_z_score_AGE_APOE, color = "NFL"), 
              se = FALSE, method = "loess", linetype = 2) +
  labs(title = "Original Age reference group in APOE-E4 non-carriers ",
       x = "Age visit 1",
       y = "z-scores Baseline",
       color = "Variable") +
  geom_hline(yintercept = 2, linetype = "solid", alpha = 0.5) +  
  geom_vline(xintercept = 54.31, linetype = "dotted", alpha = 0.5, color = 'red') +
  theme_minimal()

# Convert ggplot to plotly
plotly_plot2 <- ggplotly(gg2)

# Print the plotly plot
plotly_plot2

```


### Amyiloid status (A+ / A-) and Age stratification

```{r}

A_positive <- biomark_df[!is.na(biomark_df$A_status_BL) & biomark_df$A_status_BL == "A+", ]
A_negative <- biomark_df[!is.na(biomark_df$A_status_BL) & biomark_df$A_status_BL == "A-", ]


# Function for multiple regression
perform_mult_regression <- function(data, dependent_variable, covariates) {
  formula <- as.formula(paste(dependent_variable, "~", paste(covariates, collapse = "+")))
  model <- lm(formula, data = data, na.action = 'na.exclude')
  result <- list(
    dependent_variable = dependent_variable,
    model = model,
    summary_result = summary(model)
  )
  return(result)
}

covariates <- "Sex"

# Carrier model
A_positive_age_models <- vector("list", length = 10)

for (i in seq_along(baseline_cols)) {
  variable <- baseline_cols[i]
  model_result <- perform_mult_regression(A_positive, variable, covariates)
  A_positive_age_models[[i]] <- model_result
}

# Non-carrier model
A_negative_age_models <- vector("list", length = 10)

for (i in seq_along(baseline_cols)) {
  variable <- baseline_cols[i]
  model_result <- perform_mult_regression(A_negative, variable, covariates)
  A_negative_age_models[[i]] <- model_result
}

```



```{r}
# A status, Age reference groups

## A+ age quantiles
quantile(biomark_df$Age_V1S1, probs = 0.10, na.rm = TRUE) # 54.31  

## A- age quantiles
quantile(biomark_df$Age_V1S1, probs = 0.10, na.rm = TRUE) # 54.31   

# A status reference groups

# A+ age
residuals_age_A_positive <- list()
for (i in seq_along(A_positive_age_models)) {
  model <- A_positive_age_models[[i]]$model
  residuals_subset <- residuals(model)[A_positive$Age_V1S1 < 54.31 ]
  residuals_mean <- mean(residuals_subset, na.rm = TRUE)
  residuals_sd <- sd(residuals_subset, na.rm = TRUE)
  
  residuals_age_A_positive[[i]] <- list(
    model_name = A_positive_age_models[[i]]$dependent_variable,
    residuals_mean = residuals_mean,
    residuals_sd = residuals_sd
  )
  A_positive[paste0("age_mean_", A_positive_age_models[[i]]$dependent_variable)] <- residuals_mean
  A_positive[paste0("age_sd_", A_positive_age_models[[i]]$dependent_variable)] <- residuals_sd
}
age_A_positive_df <- do.call(rbind, residuals_age_A_positive)

# Non carrier age
residuals_age_A_negative <- list()
for (i in seq_along(A_negative_age_models)) {
  model <- A_negative_age_models[[i]]$model
  residuals_subset <- residuals(model)[A_negative$Age_V1S1 < 54.31 ]
  residuals_mean <- mean(residuals_subset, na.rm = TRUE)
  residuals_sd <- sd(residuals_subset, na.rm = TRUE)
  
  residuals_age_A_negative[[i]] <- list(
    model_name = A_negative_age_models[[i]]$dependent_variable,
    residuals_mean = residuals_mean,
    residuals_sd = residuals_sd
  )
  A_negative[paste0("age_mean_", A_negative_age_models[[i]]$dependent_variable)] <- residuals_mean
  A_negative[paste0("age_sd_", A_negative_age_models[[i]]$dependent_variable)] <- residuals_sd
}
age_A_negative_df <- do.call(rbind, residuals_age_A_negative)

```



```{r}
# Compute z-scores for APOE and Age models
compute_z_scores_AGE_A_status <- function(model_list, data) {
  for (i in seq_along(model_list)) {
    model <- model_list[[i]]$model
    variable <- model_list[[i]]$dependent_variable
    
    residuals <- residuals(model)
    
    # Get mean and standard deviation
    mean_col <- paste("age_mean_", variable, sep = "")
    sd_col <- paste("age_sd_", variable, sep = "")
    mean_val <- data[[mean_col]][1]
    sd_val <- data[[sd_col]][1]
    
    # Scale residuals by the mean and standard deviation
    z_scores <- scale(residuals, center = mean_val, scale = sd_val)
    
    # Create a new column in the data frame for the scaled z-scores
    z_score_col <- paste(variable, "_z_score_AGE_A_status", sep = "")
    
    # Update the data frame with the z_scores
    data <- data %>%
      mutate(!!z_score_col := z_scores)
  }
  
  return(data)
}

# Z-scores for A+ status subset
A_positive <- compute_z_scores_AGE_A_status(A_positive_age_models, A_positive)

# Z-scores for A- status subset
A_negative <- compute_z_scores_AGE_A_status(A_negative_age_models, A_negative)

```

```{r}

# Your list of z_score variables and proxy variables
z_score_AGE_A_status <- c("Ab40_plasmaF_SimoaNP4E_BL_z_score_AGE_A_status",            
 "Ab42_40_ratio_plasmaF_SimoaNP4E_BL_z_score_AGE_A_status",   
 "Ab42_plasmaF_SimoaNP4E_BL_z_score_AGE_A_status",            
 "ptau181_plasmaF_Simoa_BL_z_score_AGE_A_status",             
 "ptau217_plasmaF_MSDLilly_BL_z_score_AGE_A_status",          
 "ptau217_plasmaNF_SimoaJanssen_BL_z_score_AGE_A_status",     
 "ptau231_plasmaF_SimoaGot_BL_z_score_AGE_A_status",          
 "ttau_plasmaF_MSDLilly_BL_z_score_AGE_A_status",             
 "GFAP_plasmaF_SimoaNP4E_BL_z_score_AGE_A_status",           
 "NFL_plasmaF_SimoaNP4E_BL_z_score_AGE_A_status")
   

# Define a color palette for z_score variables
color_palette <- rainbow(length(z_score_AGE_A_status))

columns_to_multiply <- c("Ab42_40_ratio_plasmaF_SimoaNP4E_BL_z_score_AGE_A_status", "Ab42_plasmaF_SimoaNP4E_BL_z_score_AGE_A_status")

A_positive[, columns_to_multiply] <- A_positive[, columns_to_multiply] * -1
A_negative[, columns_to_multiply] <- A_negative[, columns_to_multiply] * -1

```



### A+ Age

```{r}

## Combined plots

plot_data_A_positive <- data.frame(z_score_var = rep(z_score_AGE_A_status, each = nrow(A_positive)),
                                Age_V1S1 = rep(A_positive$Age_V1S1, times = length(z_score_AGE_A_status)),
                                value = as.vector(sapply(z_score_AGE_A_status, function(z_var) A_positive[[z_var]])))


# Plot ggplot with loess smoothing for each z_score variable for A_positive subset
combined_plot_A_positive_age <- ggplot(plot_data_A_positive, aes(x = Age_V1S1, y = value, color = z_score_var)) +
  geom_smooth(method = "loess", linetype = 2, span = 0.9, aes(fill = z_score_var), alpha = 0.1, se = FALSE) +
  geom_hline(yintercept = 2, linetype = "solid", alpha = 0.5) +  
  geom_vline(xintercept = 54.31, linetype = "dotted", alpha = 0.5, color = 'red') +
  annotate("text", x = 52, y = 2.2, label = "2 s.d.", size = 3, fontface = 'bold') +
  labs(title = "Age reference group in A+ status",
       x = "Age V1S1",
       y = "Baseline z-scores)") +
  scale_color_manual(values = setNames(color_palette, z_score_AGE_A_status)) +
  theme_minimal()

# Convert ggplot to plotly plot for carrier subset
combined_age_A_positive <- ggplotly(combined_plot_A_positive_age)

# Print the interactive plot for carrier subset
combined_age_A_positive

```


### Bootstrapping
```{r}

# Function to fit loess model and calculate coefficients
loess_fit <- function(formula, data, indices) {
  d <- data[indices, ]
  fit <- loess(formula, data = d)
  pred <- predict(fit, newdata = data)
  return(pred)
}

# Bootstrap function to obtain coefficients for each variable
bootstrap_loess_coef <- function(data, formula, nboot = 1000) {
  boot_res <- boot(data, statistic = loess_fit, R = nboot, formula = formula)
  return(boot_res)
}

# List to store bootstrapped coefficients for each variable
boot_results <- list()

# Loop through each variable and perform bootstrapping
for (variable in z_score_AGE_A_status) {
  data <- A_positive[, c("Age_V1S1", variable)]
  boot_results[[variable]] <- bootstrap_loess_coef(data = data, formula = as.formula(paste(variable, "~ Age_V1S1")))
}

# Access bootstrapped coefficients for each variable
for (variable in z_score_AGE_A_status) {
  cat("Bootstrapped coefficients for", variable, ":\n")
}

# Initialize a list to store averaged predictions for each variable
averaged_predictions <- list()

# Loop through each variable to calculate averaged predictions
for (variable in z_score_AGE_A_status) {
  
  # Initialize an empty vector to store predictions from each iteration
  predictions <- numeric(nrow(A_positive))
  
  # Extract predictions from each iteration and aggregate them
  for (i in 1:1000) {
    predictions <- predictions + boot_results[[variable]]$t[i,]
  }
  
  # Calculate the average prediction across all iterations
  averaged_predictions[[variable]] <- predictions / 1000
}

averaged_predictions <- as.data.frame(averaged_predictions)

averaged_predictions$Age_V1S1  <- A_positive$Age_V1S1

```


```{r}
# Combined bootstrap plot
gg <- ggplot(data = averaged_predictions, aes(x = Age_V1S1)) +
  geom_smooth(aes(y = Ab40_plasmaF_SimoaNP4E_BL_z_score_AGE_A_status, color = "Ab40"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = Ab42_40_ratio_plasmaF_SimoaNP4E_BL_z_score_AGE_A_status, color = "Ab42_40_ratio"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = Ab42_plasmaF_SimoaNP4E_BL_z_score_AGE_A_status, color = "Ab42"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau181_plasmaF_Simoa_BL_z_score_AGE_A_status, color = "ptau181"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau217_plasmaF_MSDLilly_BL_z_score_AGE_A_status, color = "ptau217_MSDLilly"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau217_plasmaNF_SimoaJanssen_BL_z_score_AGE_A_status, color = "ptau217_SimoaJanssen"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau231_plasmaF_SimoaGot_BL_z_score_AGE_A_status, color = "ptau231"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ttau_plasmaF_MSDLilly_BL_z_score_AGE_A_status, color = "ttau_MSDLilly"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = GFAP_plasmaF_SimoaNP4E_BL_z_score_AGE_A_status, color = "GFAP"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = NFL_plasmaF_SimoaNP4E_BL_z_score_AGE_A_status, color = "NFL"), 
              se = FALSE, method = "loess", linetype = 2) +
  labs(title = "Average of Bootstraps for A+ status",
       x = "Age visit 1",
       y = "Average of z-score baseline Bootstraps",
       color = "biomarkers") +
  geom_hline(yintercept = 2, linetype = "solid", alpha = 0.5) +  
  geom_vline(xintercept = 54.31, linetype = "dotted", alpha = 0.5, color = 'red') +
  theme_minimal()

# Convert ggplot to plotly
plotly_plot <- ggplotly(gg)

# Print the plotly plot
plotly_plot
```


```{r}
# Combined original plot
gg2 <- ggplot(data = A_positive, aes(x = Age_V1S1)) +
   geom_smooth(aes(y = Ab40_plasmaF_SimoaNP4E_BL_z_score_AGE_A_status, color = "Ab40"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = Ab42_40_ratio_plasmaF_SimoaNP4E_BL_z_score_AGE_A_status, color = "Ab42_40_ratio"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = Ab42_plasmaF_SimoaNP4E_BL_z_score_AGE_A_status, color = "Ab42"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau181_plasmaF_Simoa_BL_z_score_AGE_A_status, color = "ptau181"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau217_plasmaF_MSDLilly_BL_z_score_AGE_A_status, color = "ptau217_MSDLilly"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau217_plasmaNF_SimoaJanssen_BL_z_score_AGE_A_status, color = "ptau217_SimoaJanssen"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau231_plasmaF_SimoaGot_BL_z_score_AGE_A_status, color = "ptau231"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ttau_plasmaF_MSDLilly_BL_z_score_AGE_A_status, color = "ttau_MSDLilly"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = GFAP_plasmaF_SimoaNP4E_BL_z_score_AGE_A_status, color = "GFAP"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = NFL_plasmaF_SimoaNP4E_BL_z_score_AGE_A_status, color = "NFL"), 
              se = FALSE, method = "loess", linetype = 2) +
  labs(title = "Original A+ status   ",
       x = "Age visit 1",
       y = "z-scores Baseline",
       color = "biomarkers") +
  geom_hline(yintercept = 2, linetype = "solid", alpha = 0.5) +  
  geom_vline(xintercept = 54.31, linetype = "dotted", alpha = 0.5, color = 'red') +
  theme_minimal()

# Convert ggplot to plotly
plotly_plot2 <- ggplotly(gg2)

# Print the plotly plot
plotly_plot2

```



### A- Age

```{r}
### Combined plot

## Combined plots

plot_data_A_negative <- data.frame(z_score_var = rep(z_score_AGE_A_status, each = nrow(A_negative)),
                                Age_V1S1 = rep(A_negative$Age_V1S1, times = length(z_score_AGE_A_status)),
                                value = as.vector(sapply(z_score_AGE_A_status, function(z_var) A_negative[[z_var]])))


# Plot ggplot with loess smoothing for each z_score variable for A_positive subset
combined_plot_A_negative_age <- ggplot(plot_data_A_negative, aes(x = Age_V1S1, y = value, color = z_score_var)) +
  geom_smooth(method = "loess", linetype = 2, span = 0.9, aes(fill = z_score_var), alpha = 0.1, se = FALSE) +
  geom_hline(yintercept = 2, linetype = "solid", alpha = 0.5) +  
  geom_vline(xintercept = 54.162, linetype = "dotted", alpha = 0.5, color = 'red') +
  annotate("text", x = 52, y = 2.2, label = "2 s.d.", size = 3, fontface = 'bold') +
  labs(title = "Age reference group in A- status",
       x = "Age V1S1",
       y = "Baseline z-scores)") +
  scale_color_manual(values = setNames(color_palette, z_score_AGE_A_status)) +
  theme_minimal()

# Convert ggplot to plotly plot for carrier subset
combined_age_A_negative <- ggplotly(combined_plot_A_negative_age)

# Print the interactive plot for carrier subset
combined_age_A_negative

```


### Bootstrapping
```{r}

# Function to fit loess model and calculate coefficients
loess_fit <- function(formula, data, indices) {
  d <- data[indices, ]
  fit <- loess(formula, data = d)
  pred <- predict(fit, newdata = data)
  return(pred)
}

# Bootstrap function to obtain coefficients for each variable
bootstrap_loess_coef <- function(data, formula, nboot = 1000) {
  boot_res <- boot(data, statistic = loess_fit, R = nboot, formula = formula)
  return(boot_res)
}

# List to store bootstrapped coefficients for each variable
boot_results <- list()

# Loop through each variable and perform bootstrapping
for (variable in z_score_AGE_A_status) {
  data <- A_negative[, c("Age_V1S1", variable)]
  boot_results[[variable]] <- bootstrap_loess_coef(data = data, formula = as.formula(paste(variable, "~ Age_V1S1")))
}

# Access bootstrapped coefficients for each variable
for (variable in z_score_AGE_A_status) {
  cat("Bootstrapped coefficients for", variable, ":\n")
}

# Initialize a list to store averaged predictions for each variable
averaged_predictions <- list()

# Loop through each variable to calculate averaged predictions
for (variable in z_score_AGE_A_status) {
  
  # Initialize an empty vector to store predictions from each iteration
  predictions <- numeric(nrow(A_negative))
  
  # Extract predictions from each iteration and aggregate them
  for (i in 1:1000) {
    predictions <- predictions + boot_results[[variable]]$t[i,]
  }
  
  # Calculate the average prediction across all iterations
  averaged_predictions[[variable]] <- predictions / 1000
}

averaged_predictions <- as.data.frame(averaged_predictions)

averaged_predictions$Age_V1S1  <- A_negative$Age_V1S1


```



```{r}
# Combined bootstrap plot
gg <- ggplot(data = averaged_predictions, aes(x = Age_V1S1)) +
  geom_smooth(aes(y = Ab40_plasmaF_SimoaNP4E_BL_z_score_AGE_A_status, color = "Ab40"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = Ab42_40_ratio_plasmaF_SimoaNP4E_BL_z_score_AGE_A_status, color = "Ab42_40_ratio"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = Ab42_plasmaF_SimoaNP4E_BL_z_score_AGE_A_status, color = "Ab42"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau181_plasmaF_Simoa_BL_z_score_AGE_A_status, color = "ptau181"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau217_plasmaF_MSDLilly_BL_z_score_AGE_A_status, color = "ptau217_MSDLilly"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau217_plasmaNF_SimoaJanssen_BL_z_score_AGE_A_status, color = "ptau217_SimoaJanssen"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau231_plasmaF_SimoaGot_BL_z_score_AGE_A_status, color = "ptau231"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ttau_plasmaF_MSDLilly_BL_z_score_AGE_A_status, color = "ttau_MSDLilly"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = GFAP_plasmaF_SimoaNP4E_BL_z_score_AGE_A_status, color = "GFAP"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = NFL_plasmaF_SimoaNP4E_BL_z_score_AGE_A_status, color = "NFL"), 
              se = FALSE, method = "loess", linetype = 2) +
  labs(title = "Average of Bootstraps for A- status ",
       x = "Age visit 1",
       y = "Average of z-score baseline Bootstraps",
       color = "biomarkers") +
  geom_hline(yintercept = 2, linetype = "solid", alpha = 0.5) +  
  geom_vline(xintercept = 54.162, linetype = "dotted", alpha = 0.5, color = 'red') +
  theme_minimal()

# Convert ggplot to plotly
plotly_plot <- ggplotly(gg)

# Print the plotly plot
plotly_plot
```


```{r}
# Combined original plot
gg2 <- ggplot(data = A_negative, aes(x = Age_V1S1)) +
  geom_smooth(aes(y = Ab40_plasmaF_SimoaNP4E_BL_z_score_AGE_A_status, color = "Ab40"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = Ab42_40_ratio_plasmaF_SimoaNP4E_BL_z_score_AGE_A_status, color = "Ab42_40_ratio"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = Ab42_plasmaF_SimoaNP4E_BL_z_score_AGE_A_status, color = "Ab42"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau181_plasmaF_Simoa_BL_z_score_AGE_A_status, color = "ptau181"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau217_plasmaF_MSDLilly_BL_z_score_AGE_A_status, color = "ptau217_MSDLilly"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau217_plasmaNF_SimoaJanssen_BL_z_score_AGE_A_status, color = "ptau217_SimoaJanssen"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ptau231_plasmaF_SimoaGot_BL_z_score_AGE_A_status, color = "ptau231"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = ttau_plasmaF_MSDLilly_BL_z_score_AGE_A_status, color = "ttau_MSDLilly"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = GFAP_plasmaF_SimoaNP4E_BL_z_score_AGE_A_status, color = "GFAP"), 
              se = FALSE, method = "loess", linetype = 2) +
  geom_smooth(aes(y = NFL_plasmaF_SimoaNP4E_BL_z_score_AGE_A_status, color = "NFL"), 
              se = FALSE, method = "loess", linetype = 2) +
  labs(title = "Original A- status  ",
       x = "Age visit 1",
       y = "z-scores Baseline",
       color = "Biomarkers") +
  geom_hline(yintercept = 2, linetype = "solid", alpha = 0.5) +  
  geom_vline(xintercept = 54.162, linetype = "dotted", alpha = 0.5, color = 'red') +
  theme_minimal()

# Convert ggplot to plotly
plotly_plot2 <- ggplotly(gg2)

# Print the plotly plot
plotly_plot2

```





